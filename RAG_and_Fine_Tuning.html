<h3 id="installing-libraries">Installing Libraries</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="op">!</span>pip install <span class="op">-</span>U gradio pdfplumber PyPDF2 camelot<span class="op">-</span>py chromadb nltk scikit<span class="op">-</span>learn sentence<span class="op">-</span>transformers langchain transformers accelerate peft accelerate bitsandbytes datasets trl <span class="op">--</span>quiet</span></code></pre></div>
<pre><code>[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m42.8/42.8 kB[0m [31m3.1 MB/s[0m eta [36m0:00:00[0m
[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m42.0/42.0 kB[0m [31m2.3 MB/s[0m eta [36m0:00:00[0m
[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m48.5/48.5 kB[0m [31m3.5 MB/s[0m eta [36m0:00:00[0m
[2K     [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m67.3/67.3 kB[0m [31m5.8 MB/s[0m eta [36m0:00:00[0m
[?25h  Installing build dependencies ... [?25l[?25hdone
  Getting requirements to build wheel ... [?25l[?25hdone
  Preparing metadata (pyproject.toml) ... [?25l[?25hdone
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m59.6/59.6 MB[0m [31m13.1 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m324.6/324.6 kB[0m [31m26.3 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m60.0/60.0 kB[0m [31m4.2 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m5.6/5.6 MB[0m [31m61.7 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m232.6/232.6 kB[0m [31m20.3 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m66.8/66.8 kB[0m [31m5.2 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m19.8/19.8 MB[0m [31m81.1 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m9.5/9.5 MB[0m [31m93.3 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m11.3/11.3 MB[0m [31m98.2 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m504.9/504.9 kB[0m [31m35.5 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m61.3/61.3 MB[0m [31m10.5 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m511.9/511.9 kB[0m [31m35.3 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m284.2/284.2 kB[0m [31m21.0 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m1.9/1.9 MB[0m [31m69.1 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m103.3/103.3 kB[0m [31m8.5 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m16.5/16.5 MB[0m [31m74.2 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m72.5/72.5 kB[0m [31m6.3 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m105.4/105.4 kB[0m [31m9.7 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m71.6/71.6 kB[0m [31m6.5 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m313.2/313.2 kB[0m [31m24.2 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m2.8/2.8 MB[0m [31m64.0 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m510.8/510.8 kB[0m [31m30.1 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m4.7/4.7 MB[0m [31m91.9 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m452.2/452.2 kB[0m [31m31.4 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m46.0/46.0 kB[0m [31m3.9 MB/s[0m eta [36m0:00:00[0m
[2K   [90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m86.8/86.8 kB[0m [31m6.6 MB/s[0m eta [36m0:00:00[0m
[?25h  Building wheel for pypika (pyproject.toml) ... [?25l[?25hdone</code></pre>
<h3 id="importing-libraries">Importing Libraries</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="im">import</span> os</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="im">import</span> re</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="im">import</span> nltk</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="im">import</span> uuid</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a><span class="im">import</span> re</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a><span class="im">import</span> chromadb</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a><span class="im">import</span> time</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a><span class="im">import</span> random</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a><span class="im">import</span> pdfplumber</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a><span class="im">from</span> nltk.corpus <span class="im">import</span> stopwords</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> TfidfVectorizer</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a><span class="im">import</span> PyPDF2</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a><span class="im">import</span> re</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a><span class="im">import</span> json</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Any, Optional, Tuple</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a><span class="im">import</span> camelot</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, asdict</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a><span class="im">import</span> torch, gc</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a><span class="im">from</span> datasets <span class="im">import</span> Dataset</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a><span class="im">from</span> transformers <span class="im">import</span> (</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a>    AutoTokenizer,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true"></a>    AutoModelForCausalLM,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true"></a>    BitsAndBytesConfig,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true"></a>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true"></a><span class="im">from</span> peft <span class="im">import</span> LoraConfig, PeftModel</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true"></a><span class="im">from</span> trl <span class="im">import</span> SFTTrainer, SFTConfig</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true"></a>nltk.download(<span class="st">&quot;stopwords&quot;</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true"></a>stop_words <span class="op">=</span> <span class="bu">set</span>(stopwords.words(<span class="st">&quot;english&quot;</span>))</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true"></a><span class="im">from</span> langchain.text_splitter <span class="im">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true"></a><span class="im">import</span> chromadb</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true"></a><span class="im">from</span> chromadb.config <span class="im">import</span> Settings</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true"></a><span class="im">from</span> chromadb.utils.embedding_functions <span class="im">import</span> DefaultEmbeddingFunction</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true"></a><span class="im">from</span> sklearn.metrics.pairwise <span class="im">import</span> cosine_similarity</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> TfidfVectorizer</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true"></a><span class="im">from</span> trl <span class="im">import</span> SFTTrainer, SFTConfig</span></code></pre></div>
<pre><code>[nltk_data] Downloading package stopwords to /root/nltk_data...
[nltk_data]   Unzipping corpora/stopwords.zip.</code></pre>
<h3 id="authorizing-hugging-face-account">Authorizing Hugging Face account</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="im">from</span> huggingface_hub <span class="im">import</span> login</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>hf_token  <span class="op">=</span> <span class="st">&#39;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&#39;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>login(token<span class="op">=</span>hf_token)</span></code></pre></div>
<h3 id="data-collection-preprocessing">Data Collection &amp; Preprocessing</h3>
<hr />
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co"># ---------------- For RAG ----------------</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="co"># Extracts clean text and tables from a PDF file. Tables are converted into a readable text block.</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="at">@dataclass</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="kw">class</span> ExtractedTable:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Data class for extracted table information&quot;&quot;&quot;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    page_number: <span class="bu">int</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    table_index: <span class="bu">int</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    title: <span class="bu">str</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>    headers: List[<span class="bu">str</span>]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>    data: List[List[<span class="bu">str</span>]]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>    table_type: <span class="bu">str</span>  <span class="co"># &#39;financial&#39;, &#39;summary&#39;, &#39;breakdown&#39;, etc.</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>    metadata: Dict[<span class="bu">str</span>, Any]</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a><span class="at">@dataclass</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="kw">class</span> ExtractedText:</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Data class for extracted text sections&quot;&quot;&quot;</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a>    page_number: <span class="bu">int</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a>    section_type: <span class="bu">str</span>  <span class="co"># &#39;header&#39;, &#39;paragraph&#39;, &#39;footer&#39;, &#39;title&#39;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a>    content: <span class="bu">str</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a>    position: Optional[Tuple[<span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>]]  <span class="co"># (x0, y0, x1, y1)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a>    font_info: Optional[Dict[<span class="bu">str</span>, Any]]</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a><span class="at">@dataclass</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a><span class="kw">class</span> FinancialDocument:</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Main data class for the extracted document&quot;&quot;&quot;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a>    document_type: <span class="bu">str</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a>    company_name: <span class="bu">str</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a>    report_period: <span class="bu">str</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a>    extraction_date: <span class="bu">str</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a>    tables: List[ExtractedTable]</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a>    text_sections: List[ExtractedText]</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a>    key_metrics: Dict[<span class="bu">str</span>, Any]</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a>    metadata: Dict[<span class="bu">str</span>, Any]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true"></a><span class="kw">class</span> ICICIFinanceReportExtractor:</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true"></a><span class="co">    Comprehensive PDF information extractor for ICICI finance reports</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true"></a><span class="co">    Designed for RAG applications and chatbot knowledge bases</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true"></a>        <span class="va">self</span>.financial_keywords <span class="op">=</span> [</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true"></a>            <span class="st">&#39;revenue&#39;</span>, <span class="st">&#39;profit&#39;</span>, <span class="st">&#39;loss&#39;</span>, <span class="st">&#39;assets&#39;</span>, <span class="st">&#39;liabilities&#39;</span>, <span class="st">&#39;equity&#39;</span>,</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true"></a>            <span class="st">&#39;cash flow&#39;</span>, <span class="st">&#39;net income&#39;</span>, <span class="st">&#39;gross margin&#39;</span>, <span class="st">&#39;ebitda&#39;</span>, <span class="st">&#39;roi&#39;</span>, <span class="st">&#39;eps&#39;</span>,</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true"></a>            <span class="st">&#39;balance sheet&#39;</span>, <span class="st">&#39;income statement&#39;</span>, <span class="st">&#39;provisions&#39;</span>, <span class="st">&#39;advances&#39;</span>,</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true"></a>            <span class="st">&#39;deposits&#39;</span>, <span class="st">&#39;investments&#39;</span>, <span class="st">&#39;capital adequacy&#39;</span>, <span class="st">&#39;npa&#39;</span>, <span class="st">&#39;crar&#39;</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true"></a>        ]</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true"></a>        <span class="va">self</span>.section_patterns <span class="op">=</span> {</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true"></a>            <span class="st">&#39;financial_highlights&#39;</span>: <span class="vs">r&#39;(financial\s+highlights|key\s+figures)&#39;</span>,</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true"></a>            <span class="st">&#39;balance_sheet&#39;</span>: <span class="vs">r&#39;(balance\s+sheet|statement\s+of\s+financial\s+position)&#39;</span>,</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true"></a>            <span class="st">&#39;income_statement&#39;</span>: <span class="vs">r&#39;(profit\s+and\s+loss|income\s+statement|statement\s+of\s+income)&#39;</span>,</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true"></a>            <span class="st">&#39;cash_flow&#39;</span>: <span class="vs">r&#39;(cash\s+flow\s+statement|statement\s+of\s+cash\s+flows)&#39;</span>,</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true"></a>            <span class="st">&#39;ratios&#39;</span>: <span class="vs">r&#39;(financial\s+ratios|key\s+ratios|performance\s+ratios)&#39;</span>,</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true"></a>            <span class="st">&#39;segment_analysis&#39;</span>: <span class="vs">r&#39;(segment\s+analysis|business\s+segment|segment\s+wise)&#39;</span>,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true"></a>            <span class="st">&#39;risk_management&#39;</span>: <span class="vs">r&#39;(risk\s+management|credit\s+risk|operational\s+risk)&#39;</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true"></a>        }</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true"></a></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true"></a>    <span class="kw">def</span> extract_from_pdf(<span class="va">self</span>, pdf_path: <span class="bu">str</span>) <span class="op">-&gt;</span> FinancialDocument:</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true"></a><span class="co">        Main extraction method that processes the entire PDF</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Starting extraction from </span><span class="sc">{</span>pdf_path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true"></a>        tables <span class="op">=</span> []</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true"></a>        text_sections <span class="op">=</span> []</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true"></a>        key_metrics <span class="op">=</span> {}</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true"></a>        metadata <span class="op">=</span> {}</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true"></a>        <span class="co"># Extract using multiple methods for comprehensive coverage</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true"></a>        all_tables <span class="op">=</span> <span class="va">self</span>._extract_tables_camelot(pdf_path)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true"></a></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true"></a>        <span class="co"># Extract text content</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true"></a>        text_sections <span class="op">=</span> <span class="va">self</span>._extract_text_content(pdf_path)</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true"></a></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true"></a>        <span class="co"># Extract key financial metrics</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true"></a>        key_metrics <span class="op">=</span> <span class="va">self</span>._extract_key_metrics(text_sections, all_tables)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true"></a></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true"></a>        <span class="co"># Extract document metadata</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true"></a>        metadata <span class="op">=</span> <span class="va">self</span>._extract_document_metadata(pdf_path, text_sections)</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true"></a></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true"></a>        <span class="co"># Create the final document structure</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true"></a>        document <span class="op">=</span> FinancialDocument(</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true"></a>            document_type<span class="op">=</span>metadata.get(<span class="st">&#39;document_type&#39;</span>, <span class="st">&#39;Financial Report&#39;</span>),</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true"></a>            company_name<span class="op">=</span>metadata.get(<span class="st">&#39;company_name&#39;</span>, <span class="st">&#39;ICICI&#39;</span>),</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true"></a>            report_period<span class="op">=</span>metadata.get(<span class="st">&#39;report_period&#39;</span>, <span class="st">&#39;Unknown&#39;</span>),</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true"></a>            extraction_date<span class="op">=</span>datetime.now().isoformat(),</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true"></a>            tables<span class="op">=</span>all_tables,</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true"></a>            text_sections<span class="op">=</span>text_sections,</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true"></a>            key_metrics<span class="op">=</span>key_metrics,</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true"></a>            metadata<span class="op">=</span>metadata</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true"></a>        )</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true"></a></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Extraction completed. Found </span><span class="sc">{</span><span class="bu">len</span>(all_tables)<span class="sc">}</span><span class="ss"> tables and </span><span class="sc">{</span><span class="bu">len</span>(text_sections)<span class="sc">}</span><span class="ss"> text sections&quot;</span>)</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true"></a>        <span class="cf">return</span> document</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true"></a></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true"></a>    <span class="kw">def</span> _extract_tables_camelot(<span class="va">self</span>, pdf_path: <span class="bu">str</span>) <span class="op">-&gt;</span> List[ExtractedTable]:</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Extract tables using Camelot (best for well-structured tables)&quot;&quot;&quot;</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true"></a>        tables <span class="op">=</span> []</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true"></a>        <span class="cf">try</span>:</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true"></a>            camelot_tables <span class="op">=</span> camelot.read_pdf(pdf_path, pages<span class="op">=</span><span class="st">&#39;all&#39;</span>, flavor<span class="op">=</span><span class="st">&#39;lattice&#39;</span>)</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true"></a></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true"></a>            <span class="cf">for</span> idx, table <span class="kw">in</span> <span class="bu">enumerate</span>(camelot_tables):</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true"></a>                df <span class="op">=</span> table.df</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true"></a>                <span class="cf">if</span> <span class="kw">not</span> df.empty <span class="kw">and</span> <span class="bu">len</span>(df.columns) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true"></a>                    <span class="co"># Clean and process the table</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true"></a>                    df <span class="op">=</span> <span class="va">self</span>._clean_dataframe(df)</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true"></a></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true"></a>                    table_obj <span class="op">=</span> ExtractedTable(</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true"></a>                        page_number<span class="op">=</span>table.page,</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true"></a>                        table_index<span class="op">=</span>idx,</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true"></a>                        title<span class="op">=</span><span class="va">self</span>._detect_table_title(df),</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true"></a>                        headers<span class="op">=</span><span class="bu">list</span>(df.columns),</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true"></a>                        data<span class="op">=</span>df.values.tolist(),</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true"></a>                        table_type<span class="op">=</span><span class="va">self</span>._classify_table(df),</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true"></a>                        metadata<span class="op">=</span>{</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true"></a>                            <span class="st">&#39;extraction_method&#39;</span>: <span class="st">&#39;camelot&#39;</span>,</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true"></a>                            <span class="st">&#39;accuracy&#39;</span>: table.accuracy,</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true"></a>                            <span class="st">&#39;whitespace&#39;</span>: table.whitespace,</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true"></a>                            <span class="st">&#39;shape&#39;</span>: df.shape</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true"></a>                        }</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true"></a>                    )</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true"></a>                    tables.append(table_obj)</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true"></a></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true"></a>            <span class="bu">print</span>(<span class="ss">f&quot;Camelot extraction failed: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true"></a></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true"></a>        <span class="cf">return</span> tables</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true"></a>    <span class="kw">def</span> _extract_text_content(<span class="va">self</span>, pdf_path: <span class="bu">str</span>) <span class="op">-&gt;</span> List[ExtractedText]:</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Extract and structure text content from PDF&quot;&quot;&quot;</span></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true"></a>        text_sections <span class="op">=</span> []</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true"></a></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true"></a>        <span class="cf">try</span>:</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true"></a>            <span class="cf">with</span> pdfplumber.<span class="bu">open</span>(pdf_path) <span class="im">as</span> pdf:</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true"></a>                <span class="cf">for</span> page_num, page <span class="kw">in</span> <span class="bu">enumerate</span>(pdf.pages, <span class="dv">1</span>):</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true"></a>                    <span class="co"># Extract text with positioning</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true"></a>                    chars <span class="op">=</span> page.chars</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true"></a></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true"></a>                    <span class="co"># Group text by lines and paragraphs</span></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true"></a>                    lines <span class="op">=</span> <span class="va">self</span>._group_text_by_lines(chars)</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true"></a>                    paragraphs <span class="op">=</span> <span class="va">self</span>._group_lines_into_paragraphs(lines)</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true"></a></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true"></a>                    <span class="cf">for</span> para_idx, paragraph <span class="kw">in</span> <span class="bu">enumerate</span>(paragraphs):</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true"></a>                        section_type <span class="op">=</span> <span class="va">self</span>._classify_text_section(paragraph[<span class="st">&#39;text&#39;</span>])</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true"></a></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true"></a>                        text_obj <span class="op">=</span> ExtractedText(</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true"></a>                            page_number<span class="op">=</span>page_num,</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true"></a>                            section_type<span class="op">=</span>section_type,</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true"></a>                            content<span class="op">=</span>paragraph[<span class="st">&#39;text&#39;</span>],</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true"></a>                            position<span class="op">=</span>paragraph.get(<span class="st">&#39;bbox&#39;</span>),</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true"></a>                            font_info<span class="op">=</span>paragraph.get(<span class="st">&#39;font_info&#39;</span>)</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true"></a>                        )</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true"></a>                        text_sections.append(text_obj)</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true"></a></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true"></a>            <span class="bu">print</span>(<span class="ss">f&quot;Text extraction failed: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true"></a></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true"></a>        <span class="cf">return</span> text_sections</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true"></a></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true"></a>    <span class="kw">def</span> _clean_dataframe(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Clean and standardize DataFrame&quot;&quot;&quot;</span></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true"></a>        <span class="co"># Remove completely empty rows and columns</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true"></a>        df <span class="op">=</span> df.dropna(how<span class="op">=</span><span class="st">&#39;all&#39;</span>).dropna(axis<span class="op">=</span><span class="dv">1</span>, how<span class="op">=</span><span class="st">&#39;all&#39;</span>)</span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true"></a></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true"></a>        <span class="co"># Clean headers</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true"></a>        df.columns <span class="op">=</span> [<span class="bu">str</span>(col).strip().replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>) <span class="cf">for</span> col <span class="kw">in</span> df.columns]</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true"></a></span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true"></a>        <span class="co"># Clean cell values</span></span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true"></a>        <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true"></a>            <span class="cf">if</span> df[col].dtype <span class="op">==</span> <span class="st">&#39;object&#39;</span>:</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true"></a>                df[col] <span class="op">=</span> df[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().<span class="bu">str</span>.replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true"></a></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true"></a>        <span class="cf">return</span> df</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true"></a></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true"></a>    <span class="kw">def</span> _detect_table_title(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Detect table title from content or position&quot;&quot;&quot;</span></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true"></a>        <span class="co"># Check first row for title-like content</span></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> df.empty:</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true"></a>            first_row <span class="op">=</span> df.iloc[<span class="dv">0</span>]</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true"></a>            <span class="cf">if</span> <span class="bu">len</span>(<span class="bu">set</span>(first_row.dropna())) <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># Merged cells indicating title</span></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true"></a>                <span class="cf">return</span> <span class="bu">str</span>(first_row.iloc[<span class="dv">0</span>])</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true"></a></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true"></a>        <span class="co"># Use column headers to infer title</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true"></a>        headers <span class="op">=</span> <span class="st">&#39; &#39;</span>.join(df.columns).lower()</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true"></a>        <span class="cf">for</span> pattern_name, pattern <span class="kw">in</span> <span class="va">self</span>.section_patterns.items():</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true"></a>            <span class="cf">if</span> re.search(pattern, headers, re.IGNORECASE):</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true"></a>                <span class="cf">return</span> pattern_name.replace(<span class="st">&#39;_&#39;</span>, <span class="st">&#39; &#39;</span>).title()</span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true"></a></span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true"></a>        <span class="cf">return</span> <span class="st">&quot;Financial Table&quot;</span></span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true"></a></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true"></a>    <span class="kw">def</span> _classify_table(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Classify table type based on content&quot;&quot;&quot;</span></span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true"></a>        content <span class="op">=</span> <span class="st">&#39; &#39;</span>.join([<span class="bu">str</span>(col) <span class="cf">for</span> col <span class="kw">in</span> df.columns] <span class="op">+</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true"></a>                          [<span class="bu">str</span>(val) <span class="cf">for</span> val <span class="kw">in</span> df.values.flatten() <span class="cf">if</span> pd.notna(val)]).lower()</span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true"></a></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true"></a>        <span class="cf">if</span> re.search(<span class="vs">r&#39;balance\s+sheet|assets|liabilities&#39;</span>, content):</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;balance_sheet&#39;</span></span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true"></a>        <span class="cf">elif</span> re.search(<span class="vs">r&#39;profit|loss|income|revenue|expense&#39;</span>, content):</span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;income_statement&#39;</span></span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true"></a>        <span class="cf">elif</span> re.search(<span class="vs">r&#39;cash\s+flow&#39;</span>, content):</span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;cash_flow&#39;</span></span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true"></a>        <span class="cf">elif</span> re.search(<span class="vs">r&#39;ratio|percentage|%&#39;</span>, content):</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;ratios&#39;</span></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true"></a>        <span class="cf">elif</span> re.search(<span class="vs">r&#39;segment|division|business&#39;</span>, content):</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;segment_analysis&#39;</span></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;general_financial&#39;</span></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true"></a></span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true"></a>    <span class="kw">def</span> _classify_text_section(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Classify text section type&quot;&quot;&quot;</span></span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true"></a>        text_lower <span class="op">=</span> text.lower().strip()</span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true"></a></span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">len</span>(text) <span class="op">&lt;</span> <span class="dv">50</span> <span class="kw">and</span> <span class="bu">any</span>(keyword <span class="kw">in</span> text_lower <span class="cf">for</span> keyword <span class="kw">in</span> [<span class="st">&#39;chairman&#39;</span>, <span class="st">&#39;ceo&#39;</span>, <span class="st">&#39;annual report&#39;</span>]):</span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;header&#39;</span></span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true"></a>        <span class="cf">elif</span> re.search(<span class="vs">r&#39;^(note|footnote|\d+\.)&#39;</span>, text_lower):</span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;footnote&#39;</span></span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true"></a>        <span class="cf">elif</span> <span class="bu">len</span>(text) <span class="op">&gt;</span> <span class="dv">500</span>:</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;paragraph&#39;</span></span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true"></a>        <span class="cf">elif</span> <span class="bu">any</span>(pattern_name <span class="kw">in</span> text_lower <span class="cf">for</span> pattern_name <span class="kw">in</span> <span class="va">self</span>.section_patterns.keys()):</span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;section_title&#39;</span></span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;general_text&#39;</span></span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true"></a></span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true"></a>    <span class="kw">def</span> _group_text_by_lines(<span class="va">self</span>, chars: List[Dict]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Group characters into lines&quot;&quot;&quot;</span></span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> chars:</span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true"></a>            <span class="cf">return</span> []</span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true"></a></span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true"></a>        lines <span class="op">=</span> []</span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true"></a>        current_line <span class="op">=</span> []</span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true"></a>        current_y <span class="op">=</span> chars[<span class="dv">0</span>][<span class="st">&#39;y0&#39;</span>]</span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true"></a></span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true"></a>        <span class="cf">for</span> char <span class="kw">in</span> chars:</span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true"></a>            <span class="cf">if</span> <span class="bu">abs</span>(char[<span class="st">&#39;y0&#39;</span>] <span class="op">-</span> current_y) <span class="op">&gt;</span> <span class="dv">5</span>:  <span class="co"># New line threshold</span></span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true"></a>                <span class="cf">if</span> current_line:</span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true"></a>                    line_text <span class="op">=</span> <span class="st">&#39;&#39;</span>.join([c[<span class="st">&#39;text&#39;</span>] <span class="cf">for</span> c <span class="kw">in</span> current_line])</span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true"></a>                    lines.append({</span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true"></a>                        <span class="st">&#39;text&#39;</span>: line_text,</span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true"></a>                        <span class="st">&#39;bbox&#39;</span>: <span class="va">self</span>._get_bbox_from_chars(current_line),</span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true"></a>                        <span class="st">&#39;chars&#39;</span>: current_line</span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true"></a>                    })</span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true"></a>                current_line <span class="op">=</span> [char]</span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true"></a>                current_y <span class="op">=</span> char[<span class="st">&#39;y0&#39;</span>]</span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true"></a>            <span class="cf">else</span>:</span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true"></a>                current_line.append(char)</span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true"></a></span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true"></a>        <span class="cf">if</span> current_line:</span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true"></a>            line_text <span class="op">=</span> <span class="st">&#39;&#39;</span>.join([c[<span class="st">&#39;text&#39;</span>] <span class="cf">for</span> c <span class="kw">in</span> current_line])</span>
<span id="cb6-251"><a href="#cb6-251" aria-hidden="true"></a>            lines.append({</span>
<span id="cb6-252"><a href="#cb6-252" aria-hidden="true"></a>                <span class="st">&#39;text&#39;</span>: line_text,</span>
<span id="cb6-253"><a href="#cb6-253" aria-hidden="true"></a>                <span class="st">&#39;bbox&#39;</span>: <span class="va">self</span>._get_bbox_from_chars(current_line),</span>
<span id="cb6-254"><a href="#cb6-254" aria-hidden="true"></a>                <span class="st">&#39;chars&#39;</span>: current_line</span>
<span id="cb6-255"><a href="#cb6-255" aria-hidden="true"></a>            })</span>
<span id="cb6-256"><a href="#cb6-256" aria-hidden="true"></a></span>
<span id="cb6-257"><a href="#cb6-257" aria-hidden="true"></a>        <span class="cf">return</span> lines</span>
<span id="cb6-258"><a href="#cb6-258" aria-hidden="true"></a></span>
<span id="cb6-259"><a href="#cb6-259" aria-hidden="true"></a>    <span class="kw">def</span> _group_lines_into_paragraphs(<span class="va">self</span>, lines: List[Dict]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb6-260"><a href="#cb6-260" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Group lines into paragraphs&quot;&quot;&quot;</span></span>
<span id="cb6-261"><a href="#cb6-261" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> lines:</span>
<span id="cb6-262"><a href="#cb6-262" aria-hidden="true"></a>            <span class="cf">return</span> []</span>
<span id="cb6-263"><a href="#cb6-263" aria-hidden="true"></a></span>
<span id="cb6-264"><a href="#cb6-264" aria-hidden="true"></a>        paragraphs <span class="op">=</span> []</span>
<span id="cb6-265"><a href="#cb6-265" aria-hidden="true"></a>        current_paragraph <span class="op">=</span> []</span>
<span id="cb6-266"><a href="#cb6-266" aria-hidden="true"></a></span>
<span id="cb6-267"><a href="#cb6-267" aria-hidden="true"></a>        <span class="cf">for</span> i, line <span class="kw">in</span> <span class="bu">enumerate</span>(lines):</span>
<span id="cb6-268"><a href="#cb6-268" aria-hidden="true"></a>            current_paragraph.append(line)</span>
<span id="cb6-269"><a href="#cb6-269" aria-hidden="true"></a></span>
<span id="cb6-270"><a href="#cb6-270" aria-hidden="true"></a>            <span class="co"># Check if this is end of paragraph</span></span>
<span id="cb6-271"><a href="#cb6-271" aria-hidden="true"></a>            is_end <span class="op">=</span> (i <span class="op">==</span> <span class="bu">len</span>(lines) <span class="op">-</span> <span class="dv">1</span> <span class="kw">or</span></span>
<span id="cb6-272"><a href="#cb6-272" aria-hidden="true"></a>                     <span class="bu">abs</span>(lines[i<span class="op">+</span><span class="dv">1</span>][<span class="st">&#39;bbox&#39;</span>][<span class="dv">1</span>] <span class="op">-</span> line[<span class="st">&#39;bbox&#39;</span>][<span class="dv">3</span>]) <span class="op">&gt;</span> <span class="dv">20</span> <span class="kw">or</span>  <span class="co"># Large vertical gap</span></span>
<span id="cb6-273"><a href="#cb6-273" aria-hidden="true"></a>                     line[<span class="st">&#39;text&#39;</span>].strip().endswith(<span class="st">&#39;.&#39;</span>))</span>
<span id="cb6-274"><a href="#cb6-274" aria-hidden="true"></a></span>
<span id="cb6-275"><a href="#cb6-275" aria-hidden="true"></a>            <span class="cf">if</span> is_end <span class="kw">and</span> current_paragraph:</span>
<span id="cb6-276"><a href="#cb6-276" aria-hidden="true"></a>                para_text <span class="op">=</span> <span class="st">&#39; &#39;</span>.join([l[<span class="st">&#39;text&#39;</span>] <span class="cf">for</span> l <span class="kw">in</span> current_paragraph]).strip()</span>
<span id="cb6-277"><a href="#cb6-277" aria-hidden="true"></a>                <span class="cf">if</span> para_text:</span>
<span id="cb6-278"><a href="#cb6-278" aria-hidden="true"></a>                    paragraphs.append({</span>
<span id="cb6-279"><a href="#cb6-279" aria-hidden="true"></a>                        <span class="st">&#39;text&#39;</span>: para_text,</span>
<span id="cb6-280"><a href="#cb6-280" aria-hidden="true"></a>                        <span class="st">&#39;bbox&#39;</span>: <span class="va">self</span>._get_combined_bbox(current_paragraph),</span>
<span id="cb6-281"><a href="#cb6-281" aria-hidden="true"></a>                        <span class="st">&#39;font_info&#39;</span>: <span class="va">self</span>._get_dominant_font_info(current_paragraph)</span>
<span id="cb6-282"><a href="#cb6-282" aria-hidden="true"></a>                    })</span>
<span id="cb6-283"><a href="#cb6-283" aria-hidden="true"></a>                current_paragraph <span class="op">=</span> []</span>
<span id="cb6-284"><a href="#cb6-284" aria-hidden="true"></a></span>
<span id="cb6-285"><a href="#cb6-285" aria-hidden="true"></a>        <span class="cf">return</span> paragraphs</span>
<span id="cb6-286"><a href="#cb6-286" aria-hidden="true"></a></span>
<span id="cb6-287"><a href="#cb6-287" aria-hidden="true"></a>    <span class="kw">def</span> _get_bbox_from_chars(<span class="va">self</span>, chars: List[Dict]) <span class="op">-&gt;</span> Tuple[<span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>]:</span>
<span id="cb6-288"><a href="#cb6-288" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Get bounding box from list of characters&quot;&quot;&quot;</span></span>
<span id="cb6-289"><a href="#cb6-289" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> chars:</span>
<span id="cb6-290"><a href="#cb6-290" aria-hidden="true"></a>            <span class="cf">return</span> (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb6-291"><a href="#cb6-291" aria-hidden="true"></a>        x0 <span class="op">=</span> <span class="bu">min</span>(c[<span class="st">&#39;x0&#39;</span>] <span class="cf">for</span> c <span class="kw">in</span> chars)</span>
<span id="cb6-292"><a href="#cb6-292" aria-hidden="true"></a>        y0 <span class="op">=</span> <span class="bu">min</span>(c[<span class="st">&#39;y0&#39;</span>] <span class="cf">for</span> c <span class="kw">in</span> chars)</span>
<span id="cb6-293"><a href="#cb6-293" aria-hidden="true"></a>        x1 <span class="op">=</span> <span class="bu">max</span>(c[<span class="st">&#39;x1&#39;</span>] <span class="cf">for</span> c <span class="kw">in</span> chars)</span>
<span id="cb6-294"><a href="#cb6-294" aria-hidden="true"></a>        y1 <span class="op">=</span> <span class="bu">max</span>(c[<span class="st">&#39;y1&#39;</span>] <span class="cf">for</span> c <span class="kw">in</span> chars)</span>
<span id="cb6-295"><a href="#cb6-295" aria-hidden="true"></a>        <span class="cf">return</span> (x0, y0, x1, y1)</span>
<span id="cb6-296"><a href="#cb6-296" aria-hidden="true"></a></span>
<span id="cb6-297"><a href="#cb6-297" aria-hidden="true"></a>    <span class="kw">def</span> _get_combined_bbox(<span class="va">self</span>, elements: List[Dict]) <span class="op">-&gt;</span> Tuple[<span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>]:</span>
<span id="cb6-298"><a href="#cb6-298" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Get combined bounding box from list of elements&quot;&quot;&quot;</span></span>
<span id="cb6-299"><a href="#cb6-299" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> elements:</span>
<span id="cb6-300"><a href="#cb6-300" aria-hidden="true"></a>            <span class="cf">return</span> (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb6-301"><a href="#cb6-301" aria-hidden="true"></a>        bboxes <span class="op">=</span> [e[<span class="st">&#39;bbox&#39;</span>] <span class="cf">for</span> e <span class="kw">in</span> elements]</span>
<span id="cb6-302"><a href="#cb6-302" aria-hidden="true"></a>        x0 <span class="op">=</span> <span class="bu">min</span>(bbox[<span class="dv">0</span>] <span class="cf">for</span> bbox <span class="kw">in</span> bboxes)</span>
<span id="cb6-303"><a href="#cb6-303" aria-hidden="true"></a>        y0 <span class="op">=</span> <span class="bu">min</span>(bbox[<span class="dv">1</span>] <span class="cf">for</span> bbox <span class="kw">in</span> bboxes)</span>
<span id="cb6-304"><a href="#cb6-304" aria-hidden="true"></a>        x1 <span class="op">=</span> <span class="bu">max</span>(bbox[<span class="dv">2</span>] <span class="cf">for</span> bbox <span class="kw">in</span> bboxes)</span>
<span id="cb6-305"><a href="#cb6-305" aria-hidden="true"></a>        y1 <span class="op">=</span> <span class="bu">max</span>(bbox[<span class="dv">3</span>] <span class="cf">for</span> bbox <span class="kw">in</span> bboxes)</span>
<span id="cb6-306"><a href="#cb6-306" aria-hidden="true"></a>        <span class="cf">return</span> (x0, y0, x1, y1)</span>
<span id="cb6-307"><a href="#cb6-307" aria-hidden="true"></a></span>
<span id="cb6-308"><a href="#cb6-308" aria-hidden="true"></a>    <span class="kw">def</span> _get_dominant_font_info(<span class="va">self</span>, elements: List[Dict]) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Any]:</span>
<span id="cb6-309"><a href="#cb6-309" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Get dominant font information from elements&quot;&quot;&quot;</span></span>
<span id="cb6-310"><a href="#cb6-310" aria-hidden="true"></a>        font_sizes <span class="op">=</span> []</span>
<span id="cb6-311"><a href="#cb6-311" aria-hidden="true"></a>        font_names <span class="op">=</span> []</span>
<span id="cb6-312"><a href="#cb6-312" aria-hidden="true"></a></span>
<span id="cb6-313"><a href="#cb6-313" aria-hidden="true"></a>        <span class="cf">for</span> element <span class="kw">in</span> elements:</span>
<span id="cb6-314"><a href="#cb6-314" aria-hidden="true"></a>            <span class="cf">for</span> char <span class="kw">in</span> element.get(<span class="st">&#39;chars&#39;</span>, []):</span>
<span id="cb6-315"><a href="#cb6-315" aria-hidden="true"></a>                font_sizes.append(char.get(<span class="st">&#39;size&#39;</span>, <span class="dv">12</span>))</span>
<span id="cb6-316"><a href="#cb6-316" aria-hidden="true"></a>                font_names.append(char.get(<span class="st">&#39;fontname&#39;</span>, <span class="st">&#39;unknown&#39;</span>))</span>
<span id="cb6-317"><a href="#cb6-317" aria-hidden="true"></a></span>
<span id="cb6-318"><a href="#cb6-318" aria-hidden="true"></a>        <span class="cf">if</span> font_sizes:</span>
<span id="cb6-319"><a href="#cb6-319" aria-hidden="true"></a>            <span class="cf">return</span> {</span>
<span id="cb6-320"><a href="#cb6-320" aria-hidden="true"></a>                <span class="st">&#39;dominant_size&#39;</span>: <span class="bu">max</span>(<span class="bu">set</span>(font_sizes), key<span class="op">=</span>font_sizes.count),</span>
<span id="cb6-321"><a href="#cb6-321" aria-hidden="true"></a>                <span class="st">&#39;dominant_font&#39;</span>: <span class="bu">max</span>(<span class="bu">set</span>(font_names), key<span class="op">=</span>font_names.count),</span>
<span id="cb6-322"><a href="#cb6-322" aria-hidden="true"></a>                <span class="st">&#39;avg_size&#39;</span>: np.mean(font_sizes)</span>
<span id="cb6-323"><a href="#cb6-323" aria-hidden="true"></a>            }</span>
<span id="cb6-324"><a href="#cb6-324" aria-hidden="true"></a>        <span class="cf">return</span> {}</span>
<span id="cb6-325"><a href="#cb6-325" aria-hidden="true"></a></span>
<span id="cb6-326"><a href="#cb6-326" aria-hidden="true"></a>    <span class="kw">def</span> _combine_and_deduplicate_tables(<span class="va">self</span>, <span class="op">*</span>table_lists) <span class="op">-&gt;</span> List[ExtractedTable]:</span>
<span id="cb6-327"><a href="#cb6-327" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Combine tables from different extraction methods and remove duplicates&quot;&quot;&quot;</span></span>
<span id="cb6-328"><a href="#cb6-328" aria-hidden="true"></a>        all_tables <span class="op">=</span> []</span>
<span id="cb6-329"><a href="#cb6-329" aria-hidden="true"></a>        <span class="cf">for</span> table_list <span class="kw">in</span> table_lists:</span>
<span id="cb6-330"><a href="#cb6-330" aria-hidden="true"></a>            all_tables.extend(table_list)</span>
<span id="cb6-331"><a href="#cb6-331" aria-hidden="true"></a></span>
<span id="cb6-332"><a href="#cb6-332" aria-hidden="true"></a>        <span class="co"># Simple deduplication based on content similarity</span></span>
<span id="cb6-333"><a href="#cb6-333" aria-hidden="true"></a>        unique_tables <span class="op">=</span> []</span>
<span id="cb6-334"><a href="#cb6-334" aria-hidden="true"></a>        <span class="cf">for</span> table <span class="kw">in</span> all_tables:</span>
<span id="cb6-335"><a href="#cb6-335" aria-hidden="true"></a>            is_duplicate <span class="op">=</span> <span class="va">False</span></span>
<span id="cb6-336"><a href="#cb6-336" aria-hidden="true"></a>            <span class="cf">for</span> existing_table <span class="kw">in</span> unique_tables:</span>
<span id="cb6-337"><a href="#cb6-337" aria-hidden="true"></a>                <span class="cf">if</span> <span class="va">self</span>._are_tables_similar(table, existing_table):</span>
<span id="cb6-338"><a href="#cb6-338" aria-hidden="true"></a>                    <span class="co"># Keep the one with better metadata/accuracy</span></span>
<span id="cb6-339"><a href="#cb6-339" aria-hidden="true"></a>                    <span class="cf">if</span> table.metadata.get(<span class="st">&#39;accuracy&#39;</span>, <span class="dv">0</span>) <span class="op">&gt;</span> existing_table.metadata.get(<span class="st">&#39;accuracy&#39;</span>, <span class="dv">0</span>):</span>
<span id="cb6-340"><a href="#cb6-340" aria-hidden="true"></a>                        unique_tables.remove(existing_table)</span>
<span id="cb6-341"><a href="#cb6-341" aria-hidden="true"></a>                        unique_tables.append(table)</span>
<span id="cb6-342"><a href="#cb6-342" aria-hidden="true"></a>                    is_duplicate <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-343"><a href="#cb6-343" aria-hidden="true"></a>                    <span class="cf">break</span></span>
<span id="cb6-344"><a href="#cb6-344" aria-hidden="true"></a></span>
<span id="cb6-345"><a href="#cb6-345" aria-hidden="true"></a>            <span class="cf">if</span> <span class="kw">not</span> is_duplicate:</span>
<span id="cb6-346"><a href="#cb6-346" aria-hidden="true"></a>                unique_tables.append(table)</span>
<span id="cb6-347"><a href="#cb6-347" aria-hidden="true"></a></span>
<span id="cb6-348"><a href="#cb6-348" aria-hidden="true"></a>        <span class="cf">return</span> unique_tables</span>
<span id="cb6-349"><a href="#cb6-349" aria-hidden="true"></a></span>
<span id="cb6-350"><a href="#cb6-350" aria-hidden="true"></a>    <span class="kw">def</span> _are_tables_similar(<span class="va">self</span>, table1: ExtractedTable, table2: ExtractedTable, threshold: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.8</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb6-351"><a href="#cb6-351" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Check if two tables are similar (potential duplicates)&quot;&quot;&quot;</span></span>
<span id="cb6-352"><a href="#cb6-352" aria-hidden="true"></a>        <span class="co"># Compare dimensions</span></span>
<span id="cb6-353"><a href="#cb6-353" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">len</span>(table1.headers) <span class="op">!=</span> <span class="bu">len</span>(table2.headers) <span class="kw">or</span> <span class="bu">len</span>(table1.data) <span class="op">!=</span> <span class="bu">len</span>(table2.data):</span>
<span id="cb6-354"><a href="#cb6-354" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-355"><a href="#cb6-355" aria-hidden="true"></a></span>
<span id="cb6-356"><a href="#cb6-356" aria-hidden="true"></a>        <span class="co"># Compare headers</span></span>
<span id="cb6-357"><a href="#cb6-357" aria-hidden="true"></a>        header_matches <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> h1, h2 <span class="kw">in</span> <span class="bu">zip</span>(table1.headers, table2.headers)</span>
<span id="cb6-358"><a href="#cb6-358" aria-hidden="true"></a>                           <span class="cf">if</span> h1.lower().strip() <span class="op">==</span> h2.lower().strip())</span>
<span id="cb6-359"><a href="#cb6-359" aria-hidden="true"></a>        header_similarity <span class="op">=</span> header_matches <span class="op">/</span> <span class="bu">len</span>(table1.headers)</span>
<span id="cb6-360"><a href="#cb6-360" aria-hidden="true"></a></span>
<span id="cb6-361"><a href="#cb6-361" aria-hidden="true"></a>        <span class="cf">return</span> header_similarity <span class="op">&gt;=</span> threshold</span>
<span id="cb6-362"><a href="#cb6-362" aria-hidden="true"></a></span>
<span id="cb6-363"><a href="#cb6-363" aria-hidden="true"></a>    <span class="kw">def</span> _extract_key_metrics(<span class="va">self</span>, text_sections: List[ExtractedText], tables: List[ExtractedTable]) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Any]:</span>
<span id="cb6-364"><a href="#cb6-364" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Extract key financial metrics from text and tables&quot;&quot;&quot;</span></span>
<span id="cb6-365"><a href="#cb6-365" aria-hidden="true"></a>        metrics <span class="op">=</span> {}</span>
<span id="cb6-366"><a href="#cb6-366" aria-hidden="true"></a></span>
<span id="cb6-367"><a href="#cb6-367" aria-hidden="true"></a>        <span class="co"># Extract from text</span></span>
<span id="cb6-368"><a href="#cb6-368" aria-hidden="true"></a>        <span class="cf">for</span> section <span class="kw">in</span> text_sections:</span>
<span id="cb6-369"><a href="#cb6-369" aria-hidden="true"></a>            content <span class="op">=</span> section.content.lower()</span>
<span id="cb6-370"><a href="#cb6-370" aria-hidden="true"></a>            <span class="cf">for</span> keyword <span class="kw">in</span> <span class="va">self</span>.financial_keywords:</span>
<span id="cb6-371"><a href="#cb6-371" aria-hidden="true"></a>                <span class="cf">if</span> keyword <span class="kw">in</span> content:</span>
<span id="cb6-372"><a href="#cb6-372" aria-hidden="true"></a>                    <span class="co"># Look for numerical values near keywords</span></span>
<span id="cb6-373"><a href="#cb6-373" aria-hidden="true"></a>                    pattern <span class="op">=</span> <span class="vs">rf&#39;</span><span class="sc">{</span>keyword<span class="sc">}</span><span class="vs">[\s:]*([₹\$]?\s*[\d,]+\.?\d*)&#39;</span></span>
<span id="cb6-374"><a href="#cb6-374" aria-hidden="true"></a>                    matches <span class="op">=</span> re.findall(pattern, content, re.IGNORECASE)</span>
<span id="cb6-375"><a href="#cb6-375" aria-hidden="true"></a>                    <span class="cf">if</span> matches:</span>
<span id="cb6-376"><a href="#cb6-376" aria-hidden="true"></a>                        metrics[<span class="ss">f&quot;</span><span class="sc">{</span>keyword<span class="sc">}</span><span class="ss">_from_text&quot;</span>] <span class="op">=</span> matches</span>
<span id="cb6-377"><a href="#cb6-377" aria-hidden="true"></a></span>
<span id="cb6-378"><a href="#cb6-378" aria-hidden="true"></a>        <span class="co"># Extract from tables</span></span>
<span id="cb6-379"><a href="#cb6-379" aria-hidden="true"></a>        <span class="cf">for</span> table <span class="kw">in</span> tables:</span>
<span id="cb6-380"><a href="#cb6-380" aria-hidden="true"></a>            <span class="cf">if</span> table.table_type <span class="kw">in</span> [<span class="st">&#39;balance_sheet&#39;</span>, <span class="st">&#39;income_statement&#39;</span>, <span class="st">&#39;ratios&#39;</span>]:</span>
<span id="cb6-381"><a href="#cb6-381" aria-hidden="true"></a>                <span class="co"># Extract key figures from financial tables</span></span>
<span id="cb6-382"><a href="#cb6-382" aria-hidden="true"></a>                <span class="cf">for</span> row <span class="kw">in</span> table.data:</span>
<span id="cb6-383"><a href="#cb6-383" aria-hidden="true"></a>                    <span class="cf">if</span> <span class="bu">len</span>(row) <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb6-384"><a href="#cb6-384" aria-hidden="true"></a>                        key <span class="op">=</span> <span class="bu">str</span>(row[<span class="dv">0</span>]).strip().lower()</span>
<span id="cb6-385"><a href="#cb6-385" aria-hidden="true"></a>                        <span class="cf">for</span> keyword <span class="kw">in</span> <span class="va">self</span>.financial_keywords:</span>
<span id="cb6-386"><a href="#cb6-386" aria-hidden="true"></a>                            <span class="cf">if</span> keyword <span class="kw">in</span> key:</span>
<span id="cb6-387"><a href="#cb6-387" aria-hidden="true"></a>                                metrics[<span class="ss">f&quot;</span><span class="sc">{</span>keyword<span class="sc">}</span><span class="ss">_from_table&quot;</span>] <span class="op">=</span> row[<span class="dv">1</span>:]</span>
<span id="cb6-388"><a href="#cb6-388" aria-hidden="true"></a></span>
<span id="cb6-389"><a href="#cb6-389" aria-hidden="true"></a>        <span class="cf">return</span> metrics</span>
<span id="cb6-390"><a href="#cb6-390" aria-hidden="true"></a></span>
<span id="cb6-391"><a href="#cb6-391" aria-hidden="true"></a>    <span class="kw">def</span> _extract_document_metadata(<span class="va">self</span>, pdf_path: <span class="bu">str</span>, text_sections: List[ExtractedText]) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Any]:</span>
<span id="cb6-392"><a href="#cb6-392" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Extract document metadata&quot;&quot;&quot;</span></span>
<span id="cb6-393"><a href="#cb6-393" aria-hidden="true"></a>        metadata <span class="op">=</span> {</span>
<span id="cb6-394"><a href="#cb6-394" aria-hidden="true"></a>            <span class="st">&#39;source_file&#39;</span>: pdf_path,</span>
<span id="cb6-395"><a href="#cb6-395" aria-hidden="true"></a>            <span class="st">&#39;total_pages&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb6-396"><a href="#cb6-396" aria-hidden="true"></a>            <span class="st">&#39;company_name&#39;</span>: <span class="st">&#39;ICICI&#39;</span>,</span>
<span id="cb6-397"><a href="#cb6-397" aria-hidden="true"></a>            <span class="st">&#39;document_type&#39;</span>: <span class="st">&#39;Financial Report&#39;</span>,</span>
<span id="cb6-398"><a href="#cb6-398" aria-hidden="true"></a>            <span class="st">&#39;report_period&#39;</span>: <span class="st">&#39;Unknown&#39;</span></span>
<span id="cb6-399"><a href="#cb6-399" aria-hidden="true"></a>        }</span>
<span id="cb6-400"><a href="#cb6-400" aria-hidden="true"></a></span>
<span id="cb6-401"><a href="#cb6-401" aria-hidden="true"></a>        <span class="co"># Extract from text sections</span></span>
<span id="cb6-402"><a href="#cb6-402" aria-hidden="true"></a>        all_text <span class="op">=</span> <span class="st">&#39; &#39;</span>.join([section.content <span class="cf">for</span> section <span class="kw">in</span> text_sections[:<span class="dv">5</span>]])  <span class="co"># First few sections</span></span>
<span id="cb6-403"><a href="#cb6-403" aria-hidden="true"></a></span>
<span id="cb6-404"><a href="#cb6-404" aria-hidden="true"></a>        <span class="co"># Extract report period</span></span>
<span id="cb6-405"><a href="#cb6-405" aria-hidden="true"></a>        date_patterns <span class="op">=</span> [</span>
<span id="cb6-406"><a href="#cb6-406" aria-hidden="true"></a>            <span class="vs">r&#39;for\s+the\s+year\s+ended\s+(\w+\s+\d{1,2},?\s+\d</span><span class="sc">{4}</span><span class="vs">)&#39;</span>,</span>
<span id="cb6-407"><a href="#cb6-407" aria-hidden="true"></a>            <span class="vs">r&#39;(\w+\s+\d</span><span class="sc">{4}</span><span class="vs">)\s+to\s+(\w+\s+\d</span><span class="sc">{4}</span><span class="vs">)&#39;</span>,</span>
<span id="cb6-408"><a href="#cb6-408" aria-hidden="true"></a>            <span class="vs">r&#39;FY\s*(\d</span><span class="sc">{4}</span><span class="vs">)&#39;</span>,</span>
<span id="cb6-409"><a href="#cb6-409" aria-hidden="true"></a>            <span class="vs">r&#39;(\d</span><span class="sc">{4}</span><span class="vs">-\d{2,4})&#39;</span></span>
<span id="cb6-410"><a href="#cb6-410" aria-hidden="true"></a>        ]</span>
<span id="cb6-411"><a href="#cb6-411" aria-hidden="true"></a></span>
<span id="cb6-412"><a href="#cb6-412" aria-hidden="true"></a>        <span class="cf">for</span> pattern <span class="kw">in</span> date_patterns:</span>
<span id="cb6-413"><a href="#cb6-413" aria-hidden="true"></a>            match <span class="op">=</span> re.search(pattern, all_text, re.IGNORECASE)</span>
<span id="cb6-414"><a href="#cb6-414" aria-hidden="true"></a>            <span class="cf">if</span> match:</span>
<span id="cb6-415"><a href="#cb6-415" aria-hidden="true"></a>                metadata[<span class="st">&#39;report_period&#39;</span>] <span class="op">=</span> match.group(<span class="dv">1</span>)</span>
<span id="cb6-416"><a href="#cb6-416" aria-hidden="true"></a>                <span class="cf">break</span></span>
<span id="cb6-417"><a href="#cb6-417" aria-hidden="true"></a></span>
<span id="cb6-418"><a href="#cb6-418" aria-hidden="true"></a>        <span class="cf">return</span> metadata</span>
<span id="cb6-419"><a href="#cb6-419" aria-hidden="true"></a></span>
<span id="cb6-420"><a href="#cb6-420" aria-hidden="true"></a>    <span class="kw">def</span> save_to_json(<span class="va">self</span>, document: FinancialDocument, output_path: <span class="bu">str</span>):</span>
<span id="cb6-421"><a href="#cb6-421" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Save extracted data to JSON for RAG applications&quot;&quot;&quot;</span></span>
<span id="cb6-422"><a href="#cb6-422" aria-hidden="true"></a>        <span class="co"># Convert dataclasses to dict</span></span>
<span id="cb6-423"><a href="#cb6-423" aria-hidden="true"></a>        doc_dict <span class="op">=</span> asdict(document)</span>
<span id="cb6-424"><a href="#cb6-424" aria-hidden="true"></a></span>
<span id="cb6-425"><a href="#cb6-425" aria-hidden="true"></a>        <span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">&#39;w&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb6-426"><a href="#cb6-426" aria-hidden="true"></a>            json.dump(doc_dict, f, indent<span class="op">=</span><span class="dv">2</span>, ensure_ascii<span class="op">=</span><span class="va">False</span>, default<span class="op">=</span><span class="bu">str</span>)</span>
<span id="cb6-427"><a href="#cb6-427" aria-hidden="true"></a></span>
<span id="cb6-428"><a href="#cb6-428" aria-hidden="true"></a></span>
<span id="cb6-429"><a href="#cb6-429" aria-hidden="true"></a>    <span class="kw">def</span> create_rag_chunks(<span class="va">self</span>, document: FinancialDocument) <span class="op">-&gt;</span> List[Dict[<span class="bu">str</span>, Any]]:</span>
<span id="cb6-430"><a href="#cb6-430" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Create chunks optimized for RAG applications&quot;&quot;&quot;</span></span>
<span id="cb6-431"><a href="#cb6-431" aria-hidden="true"></a>        chunks <span class="op">=</span> []</span>
<span id="cb6-432"><a href="#cb6-432" aria-hidden="true"></a></span>
<span id="cb6-433"><a href="#cb6-433" aria-hidden="true"></a>        <span class="co"># Create chunks from tables</span></span>
<span id="cb6-434"><a href="#cb6-434" aria-hidden="true"></a>        <span class="cf">for</span> table <span class="kw">in</span> document.tables:</span>
<span id="cb6-435"><a href="#cb6-435" aria-hidden="true"></a>            chunk <span class="op">=</span> {</span>
<span id="cb6-436"><a href="#cb6-436" aria-hidden="true"></a>                <span class="st">&#39;id&#39;</span>: <span class="ss">f&quot;table_</span><span class="sc">{</span>table<span class="sc">.</span>page_number<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>table<span class="sc">.</span>table_index<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb6-437"><a href="#cb6-437" aria-hidden="true"></a>                <span class="st">&#39;type&#39;</span>: <span class="st">&#39;table&#39;</span>,</span>
<span id="cb6-438"><a href="#cb6-438" aria-hidden="true"></a>                <span class="st">&#39;content&#39;</span>: <span class="ss">f&quot;Table: </span><span class="sc">{</span>table<span class="sc">.</span>title<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span> <span class="op">+</span></span>
<span id="cb6-439"><a href="#cb6-439" aria-hidden="true"></a>                          <span class="ss">f&quot;Headers: </span><span class="sc">{</span><span class="st">&#39;, &#39;</span><span class="sc">.</span>join(table.headers)<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span> <span class="op">+</span></span>
<span id="cb6-440"><a href="#cb6-440" aria-hidden="true"></a>                          <span class="ss">f&quot;Data: </span><span class="sc">{</span>json<span class="sc">.</span>dumps(table.data)<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb6-441"><a href="#cb6-441" aria-hidden="true"></a>                <span class="st">&#39;metadata&#39;</span>: {</span>
<span id="cb6-442"><a href="#cb6-442" aria-hidden="true"></a>                    <span class="st">&#39;page_number&#39;</span>: table.page_number,</span>
<span id="cb6-443"><a href="#cb6-443" aria-hidden="true"></a>                    <span class="st">&#39;table_type&#39;</span>: table.table_type,</span>
<span id="cb6-444"><a href="#cb6-444" aria-hidden="true"></a>                    <span class="st">&#39;company&#39;</span>: document.company_name,</span>
<span id="cb6-445"><a href="#cb6-445" aria-hidden="true"></a>                    <span class="st">&#39;report_period&#39;</span>: document.report_period</span>
<span id="cb6-446"><a href="#cb6-446" aria-hidden="true"></a>                }</span>
<span id="cb6-447"><a href="#cb6-447" aria-hidden="true"></a>            }</span>
<span id="cb6-448"><a href="#cb6-448" aria-hidden="true"></a>            chunks.append(chunk)</span>
<span id="cb6-449"><a href="#cb6-449" aria-hidden="true"></a></span>
<span id="cb6-450"><a href="#cb6-450" aria-hidden="true"></a>        <span class="co"># Create chunks from text sections</span></span>
<span id="cb6-451"><a href="#cb6-451" aria-hidden="true"></a>        <span class="cf">for</span> i, section <span class="kw">in</span> <span class="bu">enumerate</span>(document.text_sections):</span>
<span id="cb6-452"><a href="#cb6-452" aria-hidden="true"></a>            <span class="cf">if</span> <span class="bu">len</span>(section.content.strip()) <span class="op">&gt;</span> <span class="dv">50</span>:  <span class="co"># Only meaningful content</span></span>
<span id="cb6-453"><a href="#cb6-453" aria-hidden="true"></a>                chunk <span class="op">=</span> {</span>
<span id="cb6-454"><a href="#cb6-454" aria-hidden="true"></a>                    <span class="st">&#39;id&#39;</span>: <span class="ss">f&quot;text_</span><span class="sc">{</span>section<span class="sc">.</span>page_number<span class="sc">}</span><span class="ss">_</span><span class="sc">{i}</span><span class="ss">&quot;</span>,</span>
<span id="cb6-455"><a href="#cb6-455" aria-hidden="true"></a>                    <span class="st">&#39;type&#39;</span>: <span class="st">&#39;text&#39;</span>,</span>
<span id="cb6-456"><a href="#cb6-456" aria-hidden="true"></a>                    <span class="st">&#39;content&#39;</span>: section.content,</span>
<span id="cb6-457"><a href="#cb6-457" aria-hidden="true"></a>                    <span class="st">&#39;metadata&#39;</span>: {</span>
<span id="cb6-458"><a href="#cb6-458" aria-hidden="true"></a>                        <span class="st">&#39;page_number&#39;</span>: section.page_number,</span>
<span id="cb6-459"><a href="#cb6-459" aria-hidden="true"></a>                        <span class="st">&#39;section_type&#39;</span>: section.section_type,</span>
<span id="cb6-460"><a href="#cb6-460" aria-hidden="true"></a>                        <span class="st">&#39;company&#39;</span>: document.company_name,</span>
<span id="cb6-461"><a href="#cb6-461" aria-hidden="true"></a>                        <span class="st">&#39;report_period&#39;</span>: document.report_period</span>
<span id="cb6-462"><a href="#cb6-462" aria-hidden="true"></a>                    }</span>
<span id="cb6-463"><a href="#cb6-463" aria-hidden="true"></a>                }</span>
<span id="cb6-464"><a href="#cb6-464" aria-hidden="true"></a>                chunks.append(chunk)</span>
<span id="cb6-465"><a href="#cb6-465" aria-hidden="true"></a></span>
<span id="cb6-466"><a href="#cb6-466" aria-hidden="true"></a>        <span class="co"># Create chunks from key metrics</span></span>
<span id="cb6-467"><a href="#cb6-467" aria-hidden="true"></a>        <span class="cf">if</span> document.key_metrics:</span>
<span id="cb6-468"><a href="#cb6-468" aria-hidden="true"></a>            chunk <span class="op">=</span> {</span>
<span id="cb6-469"><a href="#cb6-469" aria-hidden="true"></a>                <span class="st">&#39;id&#39;</span>: <span class="st">&#39;key_metrics&#39;</span>,</span>
<span id="cb6-470"><a href="#cb6-470" aria-hidden="true"></a>                <span class="st">&#39;type&#39;</span>: <span class="st">&#39;metrics&#39;</span>,</span>
<span id="cb6-471"><a href="#cb6-471" aria-hidden="true"></a>                <span class="st">&#39;content&#39;</span>: <span class="ss">f&quot;Key Financial Metrics for </span><span class="sc">{</span>document<span class="sc">.</span>company_name<span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="ss">&quot;</span> <span class="op">+</span></span>
<span id="cb6-472"><a href="#cb6-472" aria-hidden="true"></a>                          json.dumps(document.key_metrics, indent<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb6-473"><a href="#cb6-473" aria-hidden="true"></a>                <span class="st">&#39;metadata&#39;</span>: {</span>
<span id="cb6-474"><a href="#cb6-474" aria-hidden="true"></a>                    <span class="st">&#39;company&#39;</span>: document.company_name,</span>
<span id="cb6-475"><a href="#cb6-475" aria-hidden="true"></a>                    <span class="st">&#39;report_period&#39;</span>: document.report_period,</span>
<span id="cb6-476"><a href="#cb6-476" aria-hidden="true"></a>                    <span class="st">&#39;metric_count&#39;</span>: <span class="bu">len</span>(document.key_metrics)</span>
<span id="cb6-477"><a href="#cb6-477" aria-hidden="true"></a>                }</span>
<span id="cb6-478"><a href="#cb6-478" aria-hidden="true"></a>            }</span>
<span id="cb6-479"><a href="#cb6-479" aria-hidden="true"></a>            chunks.append(chunk)</span>
<span id="cb6-480"><a href="#cb6-480" aria-hidden="true"></a></span>
<span id="cb6-481"><a href="#cb6-481" aria-hidden="true"></a>        <span class="cf">return</span> chunks</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">def</span> create_raw_data(pdf_folder):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="co">    Wrapper around ICICIFinanceReportExtractor</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="co">        Input  -&gt; pdf_folder (path containing PDFs)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a><span class="co">        Output -&gt; list of (extracted_text, file_name) tuples</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>    extractor <span class="op">=</span> ICICIFinanceReportExtractor()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    pdf_files <span class="op">=</span> [os.path.join(pdf_folder, f) <span class="cf">for</span> f <span class="kw">in</span> os.listdir(pdf_folder) <span class="cf">if</span> f.lower().endswith(<span class="st">&#39;.pdf&#39;</span>)]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>    results <span class="op">=</span> []</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>    <span class="cf">for</span> pdf_path <span class="kw">in</span> pdf_files:</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a>        file_name <span class="op">=</span> os.path.splitext(os.path.basename(pdf_path))[<span class="dv">0</span>]</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a>        <span class="cf">try</span>:</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a>            <span class="co"># Run new extraction</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a>            document <span class="op">=</span> extractor.extract_from_pdf(pdf_path)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a>            <span class="co"># Build combined text (like old code)</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a>            combined_text <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a>            <span class="co"># Add text sections</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a>            <span class="cf">for</span> section <span class="kw">in</span> document.text_sections:</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a>                <span class="cf">if</span> section.content:</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a>                    combined_text <span class="op">+=</span> section.content <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true"></a>            <span class="co"># Add tables</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true"></a>            <span class="cf">for</span> table <span class="kw">in</span> document.tables:</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true"></a>                table_text <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true"></a>                    [<span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, row)) <span class="cf">for</span> row <span class="kw">in</span> table.data <span class="cf">if</span> row]</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true"></a>                )</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true"></a>                combined_text <span class="op">+=</span> <span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">[TABLE]</span><span class="ch">\n</span><span class="sc">{</span>table_text<span class="sc">}</span><span class="ch">\n</span><span class="ss">[/TABLE]</span><span class="ch">\n</span><span class="ss">&quot;</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true"></a>            <span class="co"># Clean up spaces/newlines</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true"></a>            combined_text <span class="op">=</span> re.sub(<span class="vs">r&quot;\s+&quot;</span>, <span class="st">&quot; &quot;</span>, combined_text.strip())</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true"></a>            results.append((combined_text, file_name))</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true"></a>            <span class="bu">print</span>(<span class="ss">f&quot;Failed to process </span><span class="sc">{</span>pdf_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true"></a>        <span class="kw">del</span> document</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true"></a>    <span class="cf">return</span> results</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true"></a>raw_data <span class="op">=</span> create_raw_data(<span class="st">&quot;/content/drive/MyDrive/Assignment CAI&quot;</span>)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true"></a><span class="co"># cleaning</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true"></a>gc.collect()</span></code></pre></div>
<pre><code>Starting extraction from /content/drive/MyDrive/Assignment CAI/2023.pdf
Extraction completed. Found 200 tables and 9126 text sections
Starting extraction from /content/drive/MyDrive/Assignment CAI/2024.pdf
Extraction completed. Found 208 tables and 10028 text sections





1351443</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="co"># ---------------- For Fine tuning ----------------</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>MODEL_NAME <span class="op">=</span> <span class="st">&quot;meta-llama/Llama-2-7b-chat-hf&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>OUTPUT_DIR <span class="op">=</span> <span class="st">&quot;llama2-7b-chat-qlora-adapter&quot;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>os.makedirs(OUTPUT_DIR, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>data <span class="op">=</span> [</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>{</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were ICICI Bank&#39;s total standalone assets as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 18,715,145,766 (in &#39;000s). &quot;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>},</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>{</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were ICICI Bank&#39;s total consolidated assets as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 23,640,630,275 (in &#39;000s). &quot;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>},</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>{</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone deposits at March 31, 2024?&quot;</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 14,128,249,513 (in &#39;000s). &quot;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>},</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>{</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the year over year growth in standalone deposits from March 31, 2023 to March 31, 2024?&quot;</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~19.65% (from ₹ 11,808,406,972 to ₹ 14,128,249,513; in &#39;000s). &quot;</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>},</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>{</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated deposits at March 31, 2024?&quot;</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 14,435,799,524 (in &#39;000s). &quot;</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>},</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>{</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;By what percentage did consolidated assets grow year over year to March 31, 2024?&quot;</span>,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;About 20.71% (from ₹ 19,584,904,970 to ₹ 23,640,630,275; in &#39;000s). &quot;</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a>},</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>{</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone advances as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 11,844,063,894 (in &#39;000s). &quot;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a>},</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true"></a>{</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the year over year growth in standalone advances to March 31, 2024?&quot;</span>,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~16.16% (from ₹ 10,196,383,053 to ₹ 11,844,063,894; in &#39;000s). &quot;</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true"></a>},</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true"></a>{</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated advances at March 31, 2024?&quot;</span>,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 12,607,762,029 (in &#39;000s). &quot;</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true"></a>},</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true"></a>{</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone investments at March 31, 2024?&quot;</span>,</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 4,619,422,722 (in &#39;000s). &quot;</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true"></a>},</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true"></a>{</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much did standalone investments grow year over year to March 31, 2024?&quot;</span>,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~27.49% (from ₹ 3,623,297,355 to ₹ 4,619,422,722; in &#39;000s). &quot;</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true"></a>},</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true"></a>{</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated investments at March 31, 2024?&quot;</span>,</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 8,271,625,050 (in &#39;000s). &quot;</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true"></a>},</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true"></a>{</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone total income and net profit for FY2023 24?&quot;</span>,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Total income ₹ 1,658,487,109 and net profit ₹ 408,882,694 (both in &#39;000s). &quot;</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true"></a>},</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true"></a>{</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the year over year growth in standalone total income for FY2023 24?&quot;</span>,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~28.50% (from ₹ 1,290,627,859 to ₹ 1,658,487,109; in &#39;000s). &quot;</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true"></a>},</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true"></a>{</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated total income and net profit after minority interest for FY2023 24?&quot;</span>,</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Total income ₹ 2,360,377,272 and net profit after minority interest ₹ 442,563,735 (both in &#39;000s). &quot;</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true"></a>},</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true"></a>{</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How did consolidated net profit after minority interest change year over year in FY2023 24?&quot;</span>,</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~30.03% (from ₹ 340,366,408 to ₹ 442,563,735; in &#39;000s). &quot;</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true"></a>},</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true"></a>{</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was standalone interest earned in FY2023 24?&quot;</span>,</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,428,909,420 (in &#39;000s). &quot;</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true"></a>},</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true"></a>{</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the growth in standalone interest earned in FY2023 24?&quot;</span>,</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~30.82% year over year (₹ 1,428,909,420 vs ₹ 1,092,313,380; in &#39;000s). &quot;</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true"></a>},</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true"></a>{</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was standalone interest expended in FY2023 24?&quot;</span>,</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 685,852,236 (in &#39;000s). &quot;</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true"></a>},</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true"></a>{</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;By what percentage did consolidated interest expended rise in FY2023 24?&quot;</span>,</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;About 46.62% year over year (₹ 741,081,627 vs ₹ 505,433,879; in &#39;000s). &quot;</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true"></a>},</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true"></a>{</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was standalone other income in FY2023 24?&quot;</span>,</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 229,577,689 (in &#39;000s). &quot;</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true"></a>},</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true"></a>{</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the year over year growth in standalone other income for FY2023 24?&quot;</span>,</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~15.76% (from ₹ 198,314,479 to ₹ 229,577,689; in &#39;000s). &quot;</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true"></a>},</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true"></a>{</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone operating expenses in FY2023 24?&quot;</span>,</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 391,327,336 (in &#39;000s). &quot;</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true"></a>},</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true"></a>{</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;By how much did standalone operating expenses grow in FY2023 24?&quot;</span>,</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~19.04% year over year (₹ 391,327,336 vs ₹ 328,732,391; in &#39;000s). &quot;</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true"></a>},</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true"></a>{</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was standalone net profit for FY2023 24?&quot;</span>,</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 408,882,694 (in &#39;000s). &quot;</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true"></a>},</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true"></a>{</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the year over year growth in standalone net profit in FY2023 24?&quot;</span>,</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~28.19% (₹ 408,882,694 vs ₹ 318,964,962; in &#39;000s). &quot;</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true"></a>},</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true"></a>{</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was basic earnings per share (EPS) in FY2023 24 on a standalone basis?&quot;</span>,</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 58.38 per share. &quot;</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true"></a>},</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true"></a>{</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was diluted EPS in FY2023 24 on a standalone basis?&quot;</span>,</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 57.33 per share. &quot;</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true"></a>},</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true"></a>{</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone EPS figures for FY2022 23?&quot;</span>,</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Basic ₹ 45.79; Diluted ₹ 44.89. &quot;</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true"></a>},</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true"></a>{</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What is the face value per share?&quot;</span>,</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2.00 per share. &quot;</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true"></a>},</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true"></a>{</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much was transferred to the Statutory Reserve in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 102,221,000 (in &#39;000s). &quot;</span></span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true"></a>},</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true"></a>{</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What dividend amount was paid during FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 55,985,964 (in &#39;000s). &quot;</span></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true"></a>},</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true"></a>{</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much was transferred to the Special Reserve in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 30,208,000 (in &#39;000s). &quot;</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true"></a>},</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true"></a>{</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Did the Bank transfer any amount to &#39;Revenue and other reserves&#39; in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;No. It transferred ₹ 50,000,000 (in &#39;000s) in FY2022 23 but nil in FY2023 24. &quot;</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true"></a>},</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true"></a>{</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;Employees stock options outstanding&#39; on the standalone balance sheet at March 31, 2024?&quot;</span>,</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 14,053,180 (in &#39;000s). &quot;</span></span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true"></a>},</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true"></a>{</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was standalone share capital at March 31, 2024?&quot;</span>,</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 14,046,790 (in &#39;000s). &quot;</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true"></a>},</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true"></a>{</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone reserves and surplus at March 31, 2024?&quot;</span>,</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2,355,893,246 (in &#39;000s). &quot;</span></span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true"></a>},</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true"></a>{</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone borrowings at March 31, 2024?&quot;</span>,</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,249,675,779 (in &#39;000s). &quot;</span></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true"></a>},</span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true"></a>{</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated &#39;liabilities on policies in force&#39; as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2,813,183,300 (in &#39;000s). &quot;</span></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true"></a>},</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true"></a>{</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone contingent liabilities at March 31, 2024?&quot;</span>,</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 46,557,617,752 (in &#39;000s). &quot;</span></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true"></a>},</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true"></a>{</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the notional amount of outstanding forward exchange contracts (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 15,600,221,876 (in &#39;000s). &quot;</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true"></a>},</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true"></a>{</span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the notional of currency swaps (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 541,254,033 (in &#39;000s). &quot;</span></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true"></a>},</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true"></a>{</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the notional for interest rate swaps, currency options and interest rate futures (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 28,197,214,343 (in &#39;000s). &quot;</span></span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true"></a>},</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true"></a>{</span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much were guarantees given on behalf of constituents in India (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,374,917,331 (in &#39;000s). &quot;</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true"></a>},</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true"></a>{</span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much were guarantees given outside India (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 118,731,736 (in &#39;000s). &quot;</span></span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true"></a>},</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true"></a>{</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were acceptances, endorsements and other obligations (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 520,724,381 (in &#39;000s). &quot;</span></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true"></a>},</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true"></a>{</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;other items&#39; under contingent liabilities (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 111,167,877 (in &#39;000s). &quot;</span></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true"></a>},</span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true"></a>{</span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much were &#39;claims not acknowledged as debts&#39; (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 93,293,080 (in &#39;000s). &quot;</span></span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true"></a>},</span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true"></a>{</span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the liability for partly paid investments (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 93,095 (in &#39;000s). &quot;</span></span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true"></a>},</span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true"></a>{</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were cash and balances with RBI (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 897,116,960 (in &#39;000s). &quot;</span></span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true"></a>},</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true"></a>{</span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were balances with banks and money at call and short notice (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 502,143,120 (in &#39;000s). &quot;</span></span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true"></a>},</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true"></a>{</span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Under advances (standalone), how much were bills purchased and discounted at March 31, 2024?&quot;</span>,</span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 495,231,226 (in &#39;000s). &quot;</span></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true"></a>},</span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true"></a>{</span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the amount of cash credits, overdrafts and loans repayable on demand (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 3,438,535,695 (in &#39;000s). &quot;</span></span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true"></a>},</span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true"></a>{</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone term loans outstanding at March 31, 2024?&quot;</span>,</span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 7,910,296,973 (in &#39;000s). &quot;</span></span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true"></a>},</span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true"></a>{</span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What share of standalone advances were unsecured at March 31, 2024?&quot;</span>,</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;About 29.12% (₹ 3,448,642,432 of ₹ 11,844,063,894; in &#39;000s). &quot;</span></span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true"></a>},</span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true"></a>{</span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How were standalone advances split between India and outside India at March 31, 2024?&quot;</span>,</span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;In India: ₹ 11,509,556,801; Outside India: ₹ 334,507,093 (both in &#39;000s). &quot;</span></span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true"></a>},</span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true"></a>{</span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the deposit in the Rural Infrastructure and Development Fund (RIDF) at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 200,918,559 (in &#39;000s). &quot;</span></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true"></a>},</span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true"></a>{</span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the net deferred tax asset at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 59,546,321 (in &#39;000s). &quot;</span></span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true"></a>},</span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true"></a>{</span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were unrealised gains on foreign exchange and derivative contracts at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 160,771,101 (in &#39;000s). &quot;</span></span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true"></a>},</span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true"></a>{</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much interest was accrued at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 158,626,876 (in &#39;000s). &quot;</span></span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true"></a>},</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true"></a>{</span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were total &#39;other assets&#39; at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 743,800,667 (in &#39;000s). &quot;</span></span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true"></a>},</span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true"></a>{</span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were total fixed assets at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 108,598,403 (in &#39;000s). &quot;</span></span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true"></a>},</span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true"></a>{</span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the net block of &#39;Premises&#39; at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 60,829,270 (in &#39;000s). &quot;</span></span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true"></a>},</span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true"></a>{</span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the net block of &#39;Other fixed assets&#39; at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 44,902,906 (in &#39;000s). &quot;</span></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true"></a>},</span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true"></a>{</span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the net block of lease assets at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2,866,227 (in &#39;000s). &quot;</span></span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true"></a>},</span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true"></a>{</span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the revaluation gain recognised on premises in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,174.5 million; depreciation on revaluation was ₹ 806.9 million. &quot;</span></span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true"></a>},</span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true"></a>{</span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Were any assets held for sale disclosed at March 31, 2024 (standalone)?&quot;</span>,</span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Yes, ₹ 8.8 million of assets were held for sale. &quot;</span></span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true"></a>},</span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true"></a>{</span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What percentage of ICICI Bank&#39;s shareholding was held by the Government of India at March 31, 2024?&quot;</span>,</span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;0.22%. &quot;</span></span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true"></a>},</span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true"></a>{</span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the CET1 CRAR at March 31, 2024?&quot;</span>,</span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;15.60%. &quot;</span></span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true"></a>},</span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true"></a>{</span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the Tier 1 CRAR at March 31, 2024?&quot;</span>,</span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;15.60%. &quot;</span></span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true"></a>},</span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true"></a>{</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the total CRAR at March 31, 2024?&quot;</span>,</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;16.33%. &quot;</span></span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true"></a>},</span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true"></a>{</span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the leverage ratio at March 31, 2024?&quot;</span>,</span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;9.79%. &quot;</span></span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true"></a>},</span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true"></a>{</span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were total Risk Weighted Assets (RWAs) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 13,727,616.7 million. &quot;</span></span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true"></a>},</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true"></a>{</span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was CET1 capital (₹ million) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2,142,170.4 million. &quot;</span></span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true"></a>},</span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true"></a>{</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was Tier 2 capital (₹ million) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 100,104.4 million. &quot;</span></span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true"></a>},</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true"></a>{</span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Was there any Additional Tier 1 (AT1) capital outstanding at March 31, 2024?&quot;</span>,</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;No; AT1 was nil at March 31, 2024 (₹ 51,400.0 million at March 31, 2023). &quot;</span></span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true"></a>},</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true"></a>{</span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much equity capital was raised via ESOP exercises in FY2023 24?&quot;</span>,</span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 12,285.2 million. &quot;</span></span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true"></a>},</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true"></a>{</span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the net interest margin (NIM) for FY2023 24?&quot;</span>,</span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;4.53%. &quot;</span></span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true"></a>},</span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true"></a>{</span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the return on assets (RoA) in FY2023 24?&quot;</span>,</span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;2.37%. &quot;</span></span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true"></a>},</span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true"></a>{</span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the cost of deposits in FY2023 24?&quot;</span>,</span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;4.61%. &quot;</span></span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true"></a>},</span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true"></a>{</span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was &#39;interest income to working funds&#39; in FY2023 24?&quot;</span>,</span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;8.29%. &quot;</span></span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true"></a>},</span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true"></a>{</span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was &#39;non interest income to working funds&#39; in FY2023 24?&quot;</span>,</span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;1.33%. &quot;</span></span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true"></a>},</span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true"></a>{</span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was net profit per employee in FY2023 24?&quot;</span>,</span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2.9 million. &quot;</span></span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true"></a>},</span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true"></a>{</span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was business per employee (average deposits plus average advances) in FY2023 24?&quot;</span>,</span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 168.4 million. &quot;</span></span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true"></a>},</span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true"></a>{</span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the Liquidity Coverage Ratio (LCR) for the quarter ended March 31, 2024?&quot;</span>,</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;122.84%. &quot;</span></span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true"></a>},</span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true"></a>{</span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the total high quality liquid assets (HQLA) used in the LCR calculation for the quarter ended March 31, 2024?&quot;</span>,</span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 3,940,112.5 million. &quot;</span></span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true"></a>},</span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true"></a>{</span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the LCR for the quarter ended March 31, 2023 (for comparison)?&quot;</span>,</span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;124.13%. &quot;</span></span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true"></a>},</span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true"></a>{</span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Who manages the Bank&#39;s liquidity and what is the governance structure?&quot;</span>,</span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Liquidity is managed by the Asset Liability Management Group (ALMG) under the oversight of the Asset Liability Management Committee (ALCO); ALMG India manages domestic liquidity while overseas branches follow a decentralised day to day approach with centralised long term funding. &quot;</span></span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true"></a>},</span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true"></a>{</span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were the contributions of key liability products to total liabilities at March 31, 2024?&quot;</span>,</span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Term deposits 43.65%, savings deposits 21.49%, current account deposits 10.34%, and bond borrowings 3.33%. &quot;</span></span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true"></a>},</span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true"></a>{</span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What share of total deposits was held by the top 20 depositors at March 31, 2024?&quot;</span>,</span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;3.44%. &quot;</span></span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true"></a>},</span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true"></a>{</span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What portion of total liabilities came from significant counterparties&#39; borrowings at March 31, 2024?&quot;</span>,</span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;1.43</span><span class="sc">% o</span><span class="st">f total liabilities. &quot;</span></span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true"></a>},</span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true"></a>{</span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What share of weighted cash outflows in Q4 FY2024 came from unsecured wholesale funding?&quot;</span>,</span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;62.08</span><span class="sc">% o</span><span class="st">f total weighted cash outflows. &quot;</span></span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true"></a>},</span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true"></a>{</span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were the shares of retail deposits and contingent funding obligations in weighted cash outflows (Q4 FY2024)?&quot;</span>,</span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Retail deposits 17.99%; other contingent funding obligations 7.66%. &quot;</span></span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true"></a>},</span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true"></a>{</span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the FALLCR carve out (government securities available for LCR/MSF) amount at March 31, 2024?&quot;</span>,</span>
<span id="cb9-381"><a href="#cb9-381" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 3,538,601.0 million (vs ₹ 2,753,045.5 million at March 31, 2023). &quot;</span></span>
<span id="cb9-382"><a href="#cb9-382" aria-hidden="true"></a>},</span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true"></a>{</span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were cash and balances with central banks used for LCR at March 31, 2024?&quot;</span>,</span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 215,857.4 million (vs ₹ 320,660.8 million at March 31, 2023). &quot;</span></span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true"></a>},</span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true"></a>{</span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were average Level 2 assets at March 31, 2024?&quot;</span>,</span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 146,666.4 million (vs ₹ 127,857.7 million at March 31, 2023). &quot;</span></span>
<span id="cb9-390"><a href="#cb9-390" aria-hidden="true"></a>},</span>
<span id="cb9-391"><a href="#cb9-391" aria-hidden="true"></a>{</span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much was transferred to the Depositor Education and Awareness Fund (DEAF) during FY2023 24 and what was the closing balance?&quot;</span>,</span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Transfers during the year ₹ 2,266.4 million; closing balance ₹ 17,696.3 million. &quot;</span></span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true"></a>},</span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true"></a>{</span>
<span id="cb9-396"><a href="#cb9-396" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the DICGC insurance premium paid in FY2023 24?&quot;</span>,</span>
<span id="cb9-397"><a href="#cb9-397" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 14,532.6 million (excluding GST). &quot;</span></span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true"></a>},</span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true"></a>{</span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Were any amounts due to MSME suppliers outstanding at March 31, 2024?&quot;</span>,</span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;No; nil principal and nil interest were outstanding. &quot;</span></span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true"></a>},</span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true"></a>{</span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the gross NPA ratio at March 31, 2024?&quot;</span>,</span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;2.26</span><span class="sc">% o</span><span class="st">f gross advances. &quot;</span></span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true"></a>},</span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true"></a>{</span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the net NPA ratio at March 31, 2024?&quot;</span>,</span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;0.45</span><span class="sc">% o</span><span class="st">f net advances. &quot;</span></span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true"></a>},</span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true"></a>{</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the provision coverage ratio at March 31, 2024?&quot;</span>,</span>
<span id="cb9-413"><a href="#cb9-413" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;80.3%. &quot;</span></span>
<span id="cb9-414"><a href="#cb9-414" aria-hidden="true"></a>},</span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true"></a>{</span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were general provisions on standard assets at March 31, 2024?&quot;</span>,</span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 58,631.6 million (₹ 47,022.4 million at March 31, 2023). &quot;</span></span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true"></a>},</span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true"></a>{</span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What percentage of total exposure was to the top 20 borrowers/customers at March 31, 2024?&quot;</span>,</span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;8.86</span><span class="sc">% o</span><span class="st">f total exposure. &quot;</span></span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true"></a>},</span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true"></a>{</span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the total exposure to the top 20 NPA accounts at March 31, 2024?&quot;</span>,</span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 115,431.9 million, representing 34.4</span><span class="sc">% o</span><span class="st">f total gross NPAs. &quot;</span></span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true"></a>},</span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true"></a>{</span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the Bank&#39;s direct exposure to the real estate sector at March 31, 2024 and its key components?&quot;</span>,</span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Direct exposure ₹ 5,115,338.0 million; of which residential mortgages ₹ 3,898,373.6 million and commercial real estate ₹ 1,152,820.6 million. &quot;</span></span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true"></a>},</span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true"></a>{</span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the total exposure to capital markets at March 31, 2024?&quot;</span>,</span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 478,451.3 million (including exposures to stockbrokers). &quot;</span></span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true"></a>},</span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true"></a>{</span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was &#39;interest/discount on advances/bills&#39; in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,109,439,334 (in &#39;000s). &quot;</span></span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true"></a>},</span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true"></a>{</span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was &#39;income on investments&#39; in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 286,309,911 (in &#39;000s). &quot;</span></span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true"></a>},</span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true"></a>{</span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much interest was earned on RBI/other inter bank balances in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 17,913,925 (in &#39;000s). &quot;</span></span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true"></a>},</span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true"></a>{</span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much of &#39;interest earned – others&#39; in FY2023 24 related to income tax refunds?&quot;</span>,</span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2,650.1 million. &quot;</span></span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true"></a>},</span>
<span id="cb9-451"><a href="#cb9-451" aria-hidden="true"></a>{</span>
<span id="cb9-452"><a href="#cb9-452" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;payments to and provisions for employees&#39; in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-453"><a href="#cb9-453" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 151,419,918 (in &#39;000s). &quot;</span></span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true"></a>},</span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true"></a>{</span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;rent, taxes and lighting&#39; expenses in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 15,335,067 (in &#39;000s). &quot;</span></span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true"></a>},</span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true"></a>{</span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;printing and stationery&#39; expenses in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 3,332,210 (in &#39;000s). &quot;</span></span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true"></a>},</span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true"></a>{</span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;interest on deposits&#39; in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 578,574,729 (in &#39;000s). &quot;</span></span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true"></a>},</span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true"></a>{</span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;interest on RBI/inter bank borrowings&#39; in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 25,256,684 (in &#39;000s). &quot;</span></span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true"></a>},</span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true"></a>{</span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;other&#39; interest expenses in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 82,020,823 (in &#39;000s). &quot;</span></span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true"></a>},</span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true"></a>{</span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;commission, exchange and brokerage&#39; income in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 168,752,999 (in &#39;000s). &quot;</span></span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true"></a>},</span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true"></a>{</span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was net profit on sale of investments in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 7,079,897 (in &#39;000s). &quot;</span></span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true"></a>},</span>
<span id="cb9-483"><a href="#cb9-483" aria-hidden="true"></a>{</span>
<span id="cb9-484"><a href="#cb9-484" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was net profit on revaluation of investments in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-485"><a href="#cb9-485" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,049,387 (in &#39;000s). &quot;</span></span>
<span id="cb9-486"><a href="#cb9-486" aria-hidden="true"></a>},</span>
<span id="cb9-487"><a href="#cb9-487" aria-hidden="true"></a>{</span>
<span id="cb9-488"><a href="#cb9-488" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much income was earned as dividends from subsidiaries/joint ventures in FY2023 24 (standalone)?&quot;</span>,</span>
<span id="cb9-489"><a href="#cb9-489" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 20,729,074 (in &#39;000s). &quot;</span></span>
<span id="cb9-490"><a href="#cb9-490" aria-hidden="true"></a>},</span>
<span id="cb9-491"><a href="#cb9-491" aria-hidden="true"></a>{</span>
<span id="cb9-492"><a href="#cb9-492" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone bills for collection at March 31, 2024, and how did they change year over year?&quot;</span>,</span>
<span id="cb9-493"><a href="#cb9-493" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,007,917,603 (in &#39;000s), up ~16.58</span><span class="sc">% f</span><span class="st">rom ₹ 864,547,740. &quot;</span></span>
<span id="cb9-494"><a href="#cb9-494" aria-hidden="true"></a>},</span>
<span id="cb9-495"><a href="#cb9-495" aria-hidden="true"></a>{</span>
<span id="cb9-496"><a href="#cb9-496" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated bills for collection at March 31, 2024?&quot;</span>,</span>
<span id="cb9-497"><a href="#cb9-497" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 1,007,917,603 (in &#39;000s). &quot;</span></span>
<span id="cb9-498"><a href="#cb9-498" aria-hidden="true"></a>},</span>
<span id="cb9-499"><a href="#cb9-499" aria-hidden="true"></a>{</span>
<span id="cb9-500"><a href="#cb9-500" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated contingent liabilities at March 31, 2024?&quot;</span>,</span>
<span id="cb9-501"><a href="#cb9-501" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 57,578,163,337 (in &#39;000s). &quot;</span></span>
<span id="cb9-502"><a href="#cb9-502" aria-hidden="true"></a>},</span>
<span id="cb9-503"><a href="#cb9-503" aria-hidden="true"></a>{</span>
<span id="cb9-504"><a href="#cb9-504" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was consolidated interest earned and interest expended in FY2023 24?&quot;</span>,</span>
<span id="cb9-505"><a href="#cb9-505" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Interest earned ₹ 1,595,159,252; interest expended ₹ 741,081,627 (both in &#39;000s). &quot;</span></span>
<span id="cb9-506"><a href="#cb9-506" aria-hidden="true"></a>},</span>
<span id="cb9-507"><a href="#cb9-507" aria-hidden="true"></a>{</span>
<span id="cb9-508"><a href="#cb9-508" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated operating expenses and provisions in FY2023 24?&quot;</span>,</span>
<span id="cb9-509"><a href="#cb9-509" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Operating expenses ₹ 977,827,922; provisions and contingencies ₹ 191,400,276 (both in &#39;000s). &quot;</span></span>
<span id="cb9-510"><a href="#cb9-510" aria-hidden="true"></a>},</span>
<span id="cb9-511"><a href="#cb9-511" aria-hidden="true"></a>{</span>
<span id="cb9-512"><a href="#cb9-512" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated advances and investments at March 31, 2024 and their year over year growth?&quot;</span>,</span>
<span id="cb9-513"><a href="#cb9-513" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Advances ₹ 12,607,762,029 (+~16.32% YoY); Investments ₹ 8,271,625,050 (+~29.33% YoY), all in &#39;000s. &quot;</span></span>
<span id="cb9-514"><a href="#cb9-514" aria-hidden="true"></a>},</span>
<span id="cb9-515"><a href="#cb9-515" aria-hidden="true"></a>{</span>
<span id="cb9-516"><a href="#cb9-516" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How did consolidated deposits change year over year to March 31, 2024?&quot;</span>,</span>
<span id="cb9-517"><a href="#cb9-517" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~19.22% to ₹ 14,435,799,524 (in &#39;000s). &quot;</span></span>
<span id="cb9-518"><a href="#cb9-518" aria-hidden="true"></a>},</span>
<span id="cb9-519"><a href="#cb9-519" aria-hidden="true"></a>{</span>
<span id="cb9-520"><a href="#cb9-520" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the quarterly average LCR range across FY2023 24?&quot;</span>,</span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Quarterly average LCRs were ~120.62%–124.13% (Mar 24 quarter at 122.84%). &quot;</span></span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true"></a>},</span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true"></a>{</span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were the top categories of cash outflows driving LCR in Q4 FY2024?&quot;</span>,</span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Unsecured wholesale funding was the primary driver at 62.08</span><span class="sc">% o</span><span class="st">f weighted outflows. &quot;</span></span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true"></a>},</span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true"></a>{</span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How much was recognised as &#39;goodwill on consolidation&#39; in the consolidated balance sheet at March 31, 2024?&quot;</span>,</span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 24,741,619 (in &#39;000s). &quot;</span></span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true"></a>},</span>
<span id="cb9-531"><a href="#cb9-531" aria-hidden="true"></a>{</span>
<span id="cb9-532"><a href="#cb9-532" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was minority interest on the consolidated balance sheet at March 31, 2024?&quot;</span>,</span>
<span id="cb9-533"><a href="#cb9-533" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 138,884,162 (in &#39;000s). &quot;</span></span>
<span id="cb9-534"><a href="#cb9-534" aria-hidden="true"></a>},</span>
<span id="cb9-535"><a href="#cb9-535" aria-hidden="true"></a>{</span>
<span id="cb9-536"><a href="#cb9-536" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the composition of standalone investments between India and outside India at March 31, 2024?&quot;</span>,</span>
<span id="cb9-537"><a href="#cb9-537" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Net investments in India ₹ 4,542,685,666; outside India ₹ 76,737,056 (both in &#39;000s). &quot;</span></span>
<span id="cb9-538"><a href="#cb9-538" aria-hidden="true"></a>},</span>
<span id="cb9-539"><a href="#cb9-539" aria-hidden="true"></a>{</span>
<span id="cb9-540"><a href="#cb9-540" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the composition of consolidated investments between India and outside India at March 31, 2024?&quot;</span>,</span>
<span id="cb9-541"><a href="#cb9-541" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Net investments in India ₹ 8,129,506,010; outside India ₹ 142,119,040 (both in &#39;000s). &quot;</span></span>
<span id="cb9-542"><a href="#cb9-542" aria-hidden="true"></a>},</span>
<span id="cb9-543"><a href="#cb9-543" aria-hidden="true"></a>{</span>
<span id="cb9-544"><a href="#cb9-544" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were priority sector advances (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-545"><a href="#cb9-545" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 3,739,060,521 (in &#39;000s). &quot;</span></span>
<span id="cb9-546"><a href="#cb9-546" aria-hidden="true"></a>},</span>
<span id="cb9-547"><a href="#cb9-547" aria-hidden="true"></a>{</span>
<span id="cb9-548"><a href="#cb9-548" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were public sector advances (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-549"><a href="#cb9-549" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 510,801,139 (in &#39;000s). &quot;</span></span>
<span id="cb9-550"><a href="#cb9-550" aria-hidden="true"></a>},</span>
<span id="cb9-551"><a href="#cb9-551" aria-hidden="true"></a>{</span>
<span id="cb9-552"><a href="#cb9-552" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were the amounts of standalone advances outside India by category at March 31, 2024?&quot;</span>,</span>
<span id="cb9-553"><a href="#cb9-553" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Bills purchased and discounted ₹ 112,888,198; syndicated &amp; term loans ₹ 107,091,606; others ₹ 114,527,289 (all in &#39;000s). &quot;</span></span>
<span id="cb9-554"><a href="#cb9-554" aria-hidden="true"></a>},</span>
<span id="cb9-555"><a href="#cb9-555" aria-hidden="true"></a>{</span>
<span id="cb9-556"><a href="#cb9-556" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;How did &#39;bills purchased and discounted&#39; change year over year (standalone)?&quot;</span>,</span>
<span id="cb9-557"><a href="#cb9-557" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Slightly lower by ~0.11% (₹ 495,231,226 vs ₹ 495,756,534; in &#39;000s). &quot;</span></span>
<span id="cb9-558"><a href="#cb9-558" aria-hidden="true"></a>},</span>
<span id="cb9-559"><a href="#cb9-559" aria-hidden="true"></a>{</span>
<span id="cb9-560"><a href="#cb9-560" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the year over year growth in cash credits/overdrafts and loans repayable on demand (standalone)?&quot;</span>,</span>
<span id="cb9-561"><a href="#cb9-561" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~22.81% (₹ 3,438,535,695 vs ₹ 2,799,818,550; in &#39;000s). &quot;</span></span>
<span id="cb9-562"><a href="#cb9-562" aria-hidden="true"></a>},</span>
<span id="cb9-563"><a href="#cb9-563" aria-hidden="true"></a>{</span>
<span id="cb9-564"><a href="#cb9-564" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the year over year growth in term loans (standalone)?&quot;</span>,</span>
<span id="cb9-565"><a href="#cb9-565" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Up ~14.63% (₹ 7,910,296,973 vs ₹ 6,900,807,969; in &#39;000s). &quot;</span></span>
<span id="cb9-566"><a href="#cb9-566" aria-hidden="true"></a>},</span>
<span id="cb9-567"><a href="#cb9-567" aria-hidden="true"></a>{</span>
<span id="cb9-568"><a href="#cb9-568" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were &#39;claims against the Bank not acknowledged as debts&#39; and &#39;other items&#39; in contingent liabilities (standalone) at March 31, 2024?&quot;</span>,</span>
<span id="cb9-569"><a href="#cb9-569" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Claims not acknowledged ₹ 93,293,080; other items ₹ 111,167,877 (both in &#39;000s). &quot;</span></span>
<span id="cb9-570"><a href="#cb9-570" aria-hidden="true"></a>},</span>
<span id="cb9-571"><a href="#cb9-571" aria-hidden="true"></a>{</span>
<span id="cb9-572"><a href="#cb9-572" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was disclosed about Letters of Comfort (LoCs) and their financial impact at March 31, 2024?&quot;</span>,</span>
<span id="cb9-573"><a href="#cb9-573" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Aggregate LoCs of ₹ 1,689.5 million were included in contingent liabilities; management noted no financial impact from these LoCs at March 31, 2024. &quot;</span></span>
<span id="cb9-574"><a href="#cb9-574" aria-hidden="true"></a>},</span>
<span id="cb9-575"><a href="#cb9-575" aria-hidden="true"></a>{</span>
<span id="cb9-576"><a href="#cb9-576" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the average number of observations used for LCR computation in the quarter ended March 31, 2024?&quot;</span>,</span>
<span id="cb9-577"><a href="#cb9-577" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;60 daily observations. &quot;</span></span>
<span id="cb9-578"><a href="#cb9-578" aria-hidden="true"></a>},</span>
<span id="cb9-579"><a href="#cb9-579" aria-hidden="true"></a>{</span>
<span id="cb9-580"><a href="#cb9-580" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were the Bank&#39;s business/information ratios for FY2023 24 (summary)?&quot;</span>,</span>
<span id="cb9-581"><a href="#cb9-581" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Interest income to working funds 8.29%, non interest income to working funds 1.33%, NIM 4.53%, RoA 2.37%. &quot;</span></span>
<span id="cb9-582"><a href="#cb9-582" aria-hidden="true"></a>},</span>
<span id="cb9-583"><a href="#cb9-583" aria-hidden="true"></a>{</span>
<span id="cb9-584"><a href="#cb9-584" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were the consolidated &#39;reserves and surplus&#39; as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-585"><a href="#cb9-585" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2,533,338,376 (in &#39;000s). &quot;</span></span>
<span id="cb9-586"><a href="#cb9-586" aria-hidden="true"></a>},</span>
<span id="cb9-587"><a href="#cb9-587" aria-hidden="true"></a>{</span>
<span id="cb9-588"><a href="#cb9-588" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated borrowings as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-589"><a href="#cb9-589" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 2,074,280,008 (in &#39;000s). &quot;</span></span>
<span id="cb9-590"><a href="#cb9-590" aria-hidden="true"></a>},</span>
<span id="cb9-591"><a href="#cb9-591" aria-hidden="true"></a>{</span>
<span id="cb9-592"><a href="#cb9-592" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated cash and balances with RBI as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-593"><a href="#cb9-593" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 899,430,231 (in &#39;000s). &quot;</span></span>
<span id="cb9-594"><a href="#cb9-594" aria-hidden="true"></a>},</span>
<span id="cb9-595"><a href="#cb9-595" aria-hidden="true"></a>{</span>
<span id="cb9-596"><a href="#cb9-596" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated balances with banks and money at call/short notice as of March 31, 2024?&quot;</span>,</span>
<span id="cb9-597"><a href="#cb9-597" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 728,258,795 (in &#39;000s). &quot;</span></span>
<span id="cb9-598"><a href="#cb9-598" aria-hidden="true"></a>}</span>
<span id="cb9-599"><a href="#cb9-599" aria-hidden="true"></a>]</span>
<span id="cb9-600"><a href="#cb9-600" aria-hidden="true"></a></span>
<span id="cb9-601"><a href="#cb9-601" aria-hidden="true"></a>SYSTEM_PROMPT <span class="op">=</span> <span class="st">&quot;You are a helpful finance assistant that answers accurately and concisely.&quot;</span></span></code></pre></div>
<h3 id="retrieval-augmented-generation-rag-system-implementation-with-advanced-technique---adaptive-chunking">Retrieval-Augmented Generation (RAG) System Implementation with Advanced technique - Adaptive chunking</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">def</span> preprocess_text_with_metadata(text, source, chunk_size<span class="op">=</span><span class="dv">500</span>, chunk_overlap<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="co">    Splits text into chunks with metadata.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>    splitter <span class="op">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op">=</span>chunk_size, chunk_overlap<span class="op">=</span>chunk_overlap)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>    chunks <span class="op">=</span> splitter.split_text(text)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>    <span class="cf">return</span> [{<span class="st">&quot;text&quot;</span>: chunk, <span class="st">&quot;metadata&quot;</span>: {<span class="st">&quot;source&quot;</span>: source}} <span class="cf">for</span> chunk <span class="kw">in</span> chunks]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a><span class="kw">def</span> adaptive_chunking(raw_data, user_query):</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a><span class="co">    Dynamically adapt chunk sizes based on the user query length.</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a><span class="co">    Longer query → smaller chunk (granular).</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a><span class="co">    Shorter query → larger chunk (broad context).</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a>    query_length <span class="op">=</span> <span class="bu">len</span>(user_query.split())</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>    <span class="cf">if</span> query_length <span class="op">&lt;=</span> <span class="dv">5</span>:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>        chunk_size <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a>    <span class="cf">elif</span> query_length <span class="op">&lt;=</span> <span class="dv">15</span>:</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a>        chunk_size <span class="op">=</span> <span class="dv">768</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true"></a>        chunk_size <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true"></a>    chunk_overlap <span class="op">=</span> <span class="bu">int</span>(chunk_size <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true"></a>    all_chunks <span class="op">=</span> []</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true"></a>    <span class="cf">for</span> text, file_name <span class="kw">in</span> raw_data:</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true"></a>        chunks <span class="op">=</span> preprocess_text_with_metadata(text, file_name, chunk_size, chunk_overlap)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true"></a>        all_chunks.extend(chunks)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true"></a>    <span class="cf">return</span> all_chunks</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true"></a><span class="kw">def</span> filter_chunks_by_metadata(all_chunks, user_query):</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true"></a><span class="co">    Filters chunks based on metadata heuristics extracted from user query.</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true"></a>    filtered <span class="op">=</span> all_chunks</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true"></a>    year_match <span class="op">=</span> re.search(<span class="vs">r&quot;(20\d</span><span class="sc">{2}</span><span class="vs">)&quot;</span>, user_query)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true"></a>    <span class="cf">if</span> year_match:</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true"></a>        year <span class="op">=</span> year_match.group(<span class="dv">1</span>)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true"></a>        filtered <span class="op">=</span> [chunk <span class="cf">for</span> chunk <span class="kw">in</span> filtered <span class="cf">if</span> year <span class="kw">in</span> chunk[<span class="st">&quot;metadata&quot;</span>][<span class="st">&quot;source&quot;</span>]]</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true"></a>    <span class="cf">return</span> filtered <span class="cf">if</span> filtered <span class="cf">else</span> all_chunks</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true"></a><span class="kw">def</span> embedding_generation(all_chunks, dense_model):</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true"></a><span class="co">    Generates dense and sparse embeddings for chunks.</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true"></a>    <span class="co"># Extract texts and metadata</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true"></a>    chunk_texts <span class="op">=</span> [chunk[<span class="st">&quot;text&quot;</span>] <span class="cf">for</span> chunk <span class="kw">in</span> all_chunks]</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true"></a>    metadatas <span class="op">=</span> [chunk[<span class="st">&quot;metadata&quot;</span>] <span class="cf">for</span> chunk <span class="kw">in</span> all_chunks]</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true"></a></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true"></a>    <span class="co"># Dense embeddings</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true"></a>    dense_embeddings <span class="op">=</span> dense_model.encode(chunk_texts, convert_to_numpy<span class="op">=</span><span class="va">True</span>, show_progress_bar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true"></a></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true"></a>    <span class="co"># Sparse embeddings</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true"></a>    tfidf_vectorizer <span class="op">=</span> TfidfVectorizer()</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true"></a>    sparse_embeddings <span class="op">=</span> tfidf_vectorizer.fit_transform(chunk_texts)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true"></a>    <span class="co"># In-memory Chroma</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true"></a>    chroma_client <span class="op">=</span> chromadb.Client(chromadb.config.Settings(anonymized_telemetry<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true"></a>    <span class="co"># Delete old collection if exists</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true"></a>    <span class="cf">if</span> <span class="st">&quot;financial_docs&quot;</span> <span class="kw">in</span> [c.name <span class="cf">for</span> c <span class="kw">in</span> chroma_client.list_collections()]:</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true"></a>        chroma_client.delete_collection(<span class="st">&quot;financial_docs&quot;</span>)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true"></a></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true"></a>    collection <span class="op">=</span> chroma_client.create_collection(name<span class="op">=</span><span class="st">&quot;financial_docs&quot;</span>)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true"></a></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true"></a>    <span class="cf">for</span> i, (text, meta, embedding) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(chunk_texts, metadatas, dense_embeddings)):</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true"></a>        collection.add(</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true"></a>            documents<span class="op">=</span>[text],</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true"></a>            embeddings<span class="op">=</span>[embedding.tolist()],</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true"></a>            metadatas<span class="op">=</span>[meta],</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true"></a>            ids<span class="op">=</span>[<span class="bu">str</span>(i)]</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true"></a>        )</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true"></a></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true"></a>    <span class="cf">return</span> tfidf_vectorizer, sparse_embeddings, collection, metadatas, chunk_texts</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true"></a></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true"></a></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true"></a><span class="kw">def</span> hybrid_retrieval(tfidf_vectorizer, sparse_embeddings, collection, metadatas, chunk_texts, query, top_k<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true"></a><span class="co">    Performs hybrid retrieval using dense and sparse embeddings.</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true"></a>    dense_query_emb <span class="op">=</span> dense_model.encode([query], convert_to_numpy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true"></a>    sparse_query_emb <span class="op">=</span> tfidf_vectorizer.transform([query])</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true"></a></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true"></a>    <span class="co"># Dense similarity from Chroma</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true"></a>    dense_results <span class="op">=</span> collection.query(</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true"></a>        query_embeddings<span class="op">=</span>dense_query_emb.tolist(),</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true"></a>        n_results<span class="op">=</span><span class="bu">len</span>(chunk_texts),</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true"></a>        include<span class="op">=</span>[<span class="st">&quot;documents&quot;</span>, <span class="st">&quot;metadatas&quot;</span>, <span class="st">&quot;distances&quot;</span>, <span class="st">&quot;embeddings&quot;</span>]</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true"></a>    )</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true"></a></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true"></a>    dense_sims <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> np.array(dense_results[<span class="st">&quot;distances&quot;</span>][<span class="dv">0</span>])  <span class="co"># cosine similarity</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true"></a>    sparse_sims <span class="op">=</span> cosine_similarity(sparse_query_emb, sparse_embeddings).flatten()</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true"></a></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true"></a>    <span class="co"># Normalize</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true"></a>    dense_norm <span class="op">=</span> (dense_sims <span class="op">-</span> dense_sims.<span class="bu">min</span>()) <span class="op">/</span> (dense_sims.<span class="bu">max</span>() <span class="op">-</span> dense_sims.<span class="bu">min</span>() <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true"></a>    sparse_norm <span class="op">=</span> (sparse_sims <span class="op">-</span> sparse_sims.<span class="bu">min</span>()) <span class="op">/</span> (sparse_sims.<span class="bu">max</span>() <span class="op">-</span> sparse_sims.<span class="bu">min</span>() <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true"></a></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true"></a>    hybrid_scores <span class="op">=</span> alpha <span class="op">*</span> dense_norm <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> sparse_norm</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true"></a></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true"></a>    top_indices <span class="op">=</span> np.argsort(hybrid_scores)[::<span class="op">-</span><span class="dv">1</span>][:top_k]</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true"></a></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true"></a>    results <span class="op">=</span> []</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true"></a>    <span class="cf">for</span> idx <span class="kw">in</span> top_indices:</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true"></a>        results.append({</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true"></a>            <span class="st">&quot;text&quot;</span>: chunk_texts[idx],</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true"></a>            <span class="st">&quot;metadata&quot;</span>: metadatas[idx],</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true"></a>        })</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true"></a>    <span class="cf">return</span> results</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true"></a></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true"></a></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true"></a><span class="kw">def</span> generate_answer(query, retrieved_chunks):</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true"></a><span class="co">    Generates an answer based on retrieved chunks.</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true"></a>    context <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join([chunk[<span class="st">&quot;text&quot;</span>] <span class="cf">for</span> chunk <span class="kw">in</span> retrieved_chunks])</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true"></a></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true"></a>    messages <span class="op">=</span> [</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true"></a>        {</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true"></a>            <span class="st">&quot;role&quot;</span>: <span class="st">&quot;system&quot;</span>,</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true"></a>            <span class="st">&quot;content&quot;</span>: <span class="st">&quot;You are a helpful assistant that answers questions using the provided context only. Don&#39;t use your knowledge to answer the question. If you don&#39;t know the answer just say I don&#39;t know&quot;</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true"></a>        },</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true"></a>        {</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true"></a>            <span class="st">&quot;role&quot;</span>: <span class="st">&quot;user&quot;</span>,</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true"></a>            <span class="st">&quot;content&quot;</span>: <span class="ss">f&quot;Context:</span><span class="ch">\n</span><span class="sc">{</span>context<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">Question:</span><span class="ch">\n</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true"></a>        }</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true"></a>    ]</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true"></a></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true"></a>    inputs <span class="op">=</span> tokenizer.apply_chat_template(</span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true"></a>        messages,</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true"></a>        add_generation_prompt<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true"></a>        tokenize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true"></a>        return_dict<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true"></a>        return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true"></a>    ).to(base_model.device)</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true"></a></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true"></a>    outputs <span class="op">=</span> base_model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true"></a>    response <span class="op">=</span> tokenizer.decode(outputs[<span class="dv">0</span>][inputs[<span class="st">&quot;input_ids&quot;</span>].shape[<span class="op">-</span><span class="dv">1</span>]:], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true"></a></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true"></a>    <span class="cf">return</span> response.strip()</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true"></a></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true"></a></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true"></a><span class="co"># ---------------- RAG Pipeline ----------------</span></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true"></a>dense_model <span class="op">=</span> SentenceTransformer(<span class="st">&quot;all-MiniLM-L6-v2&quot;</span>)</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true"></a></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true"></a><span class="kw">def</span> rag_response(raw_data, user_query):</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true"></a><span class="co">    RAG pipeline for generating responses.</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true"></a>    all_chunks <span class="op">=</span> adaptive_chunking(raw_data, user_query)</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true"></a>    filtered_chunks <span class="op">=</span> filter_chunks_by_metadata(all_chunks, user_query)</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true"></a></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true"></a>    tfidf_vectorizer, sparse_embeddings, collection, metadatas, chunk_texts <span class="op">=</span> embedding_generation(filtered_chunks, dense_model)</span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true"></a></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true"></a>    retrieved_chunks <span class="op">=</span> hybrid_retrieval(tfidf_vectorizer, sparse_embeddings, collection, metadatas, chunk_texts, user_query, top_k<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true"></a></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true"></a>    answer <span class="op">=</span> generate_answer(user_query, retrieved_chunks)</span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true"></a></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true"></a>    <span class="kw">del</span> collection</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true"></a>    <span class="cf">return</span> answer</span></code></pre></div>
<pre><code>/usr/local/lib/python3.12/dist-packages/huggingface_hub/utils/_auth.py:94: UserWarning: 
The secret `HF_TOKEN` does not exist in your Colab secrets.
To authenticate with the Hugging Face Hub, create a token in your settings tab (https://huggingface.co/settings/tokens), set it as secret in your Google Colab and restart your session.
You will be able to reuse this secret in all of your notebooks.
Please note that authentication is recommended but still optional to access public models or datasets.
  warnings.warn(



modules.json:   0%|          | 0.00/349 [00:00&lt;?, ?B/s]



config_sentence_transformers.json:   0%|          | 0.00/116 [00:00&lt;?, ?B/s]



README.md: 0.00B [00:00, ?B/s]



sentence_bert_config.json:   0%|          | 0.00/53.0 [00:00&lt;?, ?B/s]



config.json:   0%|          | 0.00/612 [00:00&lt;?, ?B/s]



model.safetensors:   0%|          | 0.00/90.9M [00:00&lt;?, ?B/s]



tokenizer_config.json:   0%|          | 0.00/350 [00:00&lt;?, ?B/s]



vocab.txt: 0.00B [00:00, ?B/s]



tokenizer.json: 0.00B [00:00, ?B/s]



special_tokens_map.json:   0%|          | 0.00/112 [00:00&lt;?, ?B/s]



config.json:   0%|          | 0.00/190 [00:00&lt;?, ?B/s]</code></pre>
<h3 id="fine-tuned-model-system-implementation-with-advanced-technique---adapter-based-parameter-efficient-tuning">Fine-Tuned Model System Implementation with Advanced technique - Adapter-Based Parameter-Efficient Tuning</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">def</span> format_chat_example(q, a):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>    <span class="co"># Instruction + model should generate answer</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>    <span class="cf">return</span> (</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>        <span class="ss">f&quot;&lt;s&gt;[INST] &lt;&lt;SYS&gt;&gt;</span><span class="ch">\n</span><span class="sc">{</span>SYSTEM_PROMPT<span class="sc">}</span><span class="ch">\n</span><span class="ss">&lt;&lt;/SYS&gt;&gt;</span><span class="ch">\n\n</span><span class="sc">{q.</span>strip()<span class="sc">}</span><span class="ch">\n</span><span class="ss">[/INST] </span><span class="sc">{a.</span>strip()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>    )</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>formatted_rows <span class="op">=</span> [{<span class="st">&quot;text&quot;</span>: format_chat_example(ex[<span class="st">&quot;question&quot;</span>], ex[<span class="st">&quot;answer&quot;</span>])}</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>                  <span class="cf">for</span> ex <span class="kw">in</span> data]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>ds <span class="op">=</span> Dataset.from_list(formatted_rows)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a><span class="co">#  4-bit quantization (QLoRA) config</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>bnb_config <span class="op">=</span> BitsAndBytesConfig(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>    load_in_4bit<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>    bnb_4bit_quant_type<span class="op">=</span><span class="st">&quot;nf4&quot;</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a>    bnb_4bit_compute_dtype<span class="op">=</span>torch.bfloat16 <span class="cf">if</span> torch.cuda.is_available() <span class="kw">and</span> torch.cuda.get_device_capability(<span class="dv">0</span>)[<span class="dv">0</span>] <span class="op">&gt;=</span> <span class="dv">8</span> <span class="cf">else</span> torch.float16,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>    bnb_4bit_use_double_quant<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a><span class="co"># Load tokenizer &amp; base model in 4-bit</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(MODEL_NAME, use_fast<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a><span class="cf">if</span> tokenizer.pad_token <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a>    tokenizer.pad_token <span class="op">=</span> tokenizer.eos_token</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>model <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a>    MODEL_NAME,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a>    quantization_config<span class="op">=</span>bnb_config,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a>    device_map<span class="op">=</span><span class="st">&quot;auto&quot;</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a>model.config.use_cache <span class="op">=</span> <span class="va">False</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a><span class="co"># LoRA setup</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a>peft_config <span class="op">=</span> LoraConfig(</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a>    r<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a>    lora_alpha<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a>    lora_dropout<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a>    bias<span class="op">=</span><span class="st">&quot;none&quot;</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a>    task_type<span class="op">=</span><span class="st">&quot;CAUSAL_LM&quot;</span>,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a>    target_modules<span class="op">=</span>[<span class="st">&quot;q_proj&quot;</span>,<span class="st">&quot;k_proj&quot;</span>,<span class="st">&quot;v_proj&quot;</span>,<span class="st">&quot;o_proj&quot;</span>,<span class="st">&quot;gate_proj&quot;</span>,<span class="st">&quot;down_proj&quot;</span>,<span class="st">&quot;up_proj&quot;</span>],</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true"></a>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true"></a><span class="co"># Training config</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true"></a>train_conf <span class="op">=</span> SFTConfig(</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true"></a>    output_dir<span class="op">=</span>OUTPUT_DIR,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true"></a>    num_train_epochs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true"></a>    per_device_train_batch_size<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true"></a>    gradient_accumulation_steps<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true"></a>    learning_rate<span class="op">=</span><span class="fl">2e-4</span>,</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true"></a>    lr_scheduler_type<span class="op">=</span><span class="st">&quot;cosine&quot;</span>,</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true"></a>    warmup_ratio<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true"></a>    logging_steps<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true"></a>    save_steps<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true"></a>    save_total_limit<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true"></a>    bf16<span class="op">=</span>(torch.cuda.is_available() <span class="kw">and</span> torch.cuda.get_device_capability(<span class="dv">0</span>)[<span class="dv">0</span>] <span class="op">&gt;=</span> <span class="dv">8</span>),</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true"></a>    fp16<span class="op">=</span><span class="kw">not</span> (torch.cuda.is_available() <span class="kw">and</span> torch.cuda.get_device_capability(<span class="dv">0</span>)[<span class="dv">0</span>] <span class="op">&gt;=</span> <span class="dv">8</span>),</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true"></a>    optim<span class="op">=</span><span class="st">&quot;paged_adamw_32bit&quot;</span>,</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true"></a>    max_length<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true"></a>    packing<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true"></a>    report_to<span class="op">=</span><span class="st">&quot;none&quot;</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true"></a>)</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true"></a>trainer <span class="op">=</span> SFTTrainer(</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true"></a>    model<span class="op">=</span>model,</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true"></a>    processing_class<span class="op">=</span>tokenizer,</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true"></a>    train_dataset<span class="op">=</span>ds,</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true"></a>    peft_config<span class="op">=</span>peft_config,</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true"></a>    args<span class="op">=</span>train_conf,</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true"></a>)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true"></a><span class="co"># Train</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true"></a></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true"></a>trainer.train()</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true"></a></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true"></a><span class="co"># Save LoRA adapter + tokenizer</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true"></a></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true"></a>trainer.model.save_pretrained(OUTPUT_DIR)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true"></a>tokenizer.save_pretrained(OUTPUT_DIR)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true"></a></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true"></a><span class="bu">print</span>(<span class="ss">f&quot;Adapter saved to: </span><span class="sc">{</span>OUTPUT_DIR<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true"></a></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true"></a><span class="kw">del</span> trainer, model</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true"></a>gc.collect()</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true"></a>    torch.cuda.empty_cache()</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true"></a>    torch.cuda.ipc_collect()</span></code></pre></div>
<pre><code>tokenizer_config.json:   0%|          | 0.00/1.62k [00:00&lt;?, ?B/s]



tokenizer.model:   0%|          | 0.00/500k [00:00&lt;?, ?B/s]



tokenizer.json:   0%|          | 0.00/1.84M [00:00&lt;?, ?B/s]



special_tokens_map.json:   0%|          | 0.00/414 [00:00&lt;?, ?B/s]



config.json:   0%|          | 0.00/614 [00:00&lt;?, ?B/s]



model.safetensors.index.json:   0%|          | 0.00/26.8k [00:00&lt;?, ?B/s]



Fetching 2 files:   0%|          | 0/2 [00:00&lt;?, ?it/s]



model-00001-of-00002.safetensors:   0%|          | 0.00/9.98G [00:00&lt;?, ?B/s]



model-00002-of-00002.safetensors:   0%|          | 0.00/3.50G [00:00&lt;?, ?B/s]



Loading checkpoint shards:   0%|          | 0/2 [00:00&lt;?, ?it/s]



generation_config.json:   0%|          | 0.00/188 [00:00&lt;?, ?B/s]



Adding EOS to train dataset:   0%|          | 0/148 [00:00&lt;?, ? examples/s]



Tokenizing train dataset:   0%|          | 0/148 [00:00&lt;?, ? examples/s]



Truncating train dataset:   0%|          | 0/148 [00:00&lt;?, ? examples/s]




&lt;div&gt;

  &lt;progress value=&#39;100&#39; max=&#39;100&#39; style=&#39;width:300px; height:20px; vertical-align: middle;&#39;&gt;&lt;/progress&gt;
  [100/100 10:10, Epoch 10/10]
&lt;/div&gt;
&lt;table border=&quot;1&quot; class=&quot;dataframe&quot;&gt;</code></pre>
<thead>
<tr style="text-align: left;">
<th>
Step
</th>
<th>
Training Loss
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
5
</td>
<td>
4.188300
</td>
</tr>
<tr>
<td>
10
</td>
<td>
3.116700
</td>
</tr>
<tr>
<td>
15
</td>
<td>
1.870800
</td>
</tr>
<tr>
<td>
20
</td>
<td>
1.190700
</td>
</tr>
<tr>
<td>
25
</td>
<td>
0.878100
</td>
</tr>
<tr>
<td>
30
</td>
<td>
0.761100
</td>
</tr>
<tr>
<td>
35
</td>
<td>
0.665700
</td>
</tr>
<tr>
<td>
40
</td>
<td>
0.603000
</td>
</tr>
<tr>
<td>
45
</td>
<td>
0.582200
</td>
</tr>
<tr>
<td>
50
</td>
<td>
0.526800
</td>
</tr>
<tr>
<td>
55
</td>
<td>
0.500600
</td>
</tr>
<tr>
<td>
60
</td>
<td>
0.504000
</td>
</tr>
<tr>
<td>
65
</td>
<td>
0.447400
</td>
</tr>
<tr>
<td>
70
</td>
<td>
0.465600
</td>
</tr>
<tr>
<td>
75
</td>
<td>
0.424900
</td>
</tr>
<tr>
<td>
80
</td>
<td>
0.412300
</td>
</tr>
<tr>
<td>
85
</td>
<td>
0.385100
</td>
</tr>
<tr>
<td>
90
</td>
<td>
0.417800
</td>
</tr>
<tr>
<td>
95
</td>
<td>
0.384700
</td>
</tr>
<tr>
<td>
100
</td>
<td>
0.389400
</td>
</tr>
</tbody>
</table>
<p>
<pre><code>Adapter saved to: llama2-7b-chat-qlora-adapter</code></pre>
<h3 id="fine-tuned-model-inferencing">Fine tuned model inferencing</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="co"># reload the base model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>base_model <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>    MODEL_NAME,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>    quantization_config<span class="op">=</span>bnb_config,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>    device_map<span class="op">=</span><span class="st">&quot;auto&quot;</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a><span class="co"># Adding Adapter</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a>infer_model <span class="op">=</span> PeftModel.from_pretrained(base_model, OUTPUT_DIR)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a>infer_tokenizer <span class="op">=</span> tokenizer</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a><span class="kw">def</span> fine_tune_response(prompt_user):</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a><span class="co">    Use fine tuned model to generate the response</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true"></a>    prompt <span class="op">=</span> (</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true"></a>        <span class="st">&quot;&lt;s&gt;[INST] &lt;&lt;SYS&gt;&gt;</span><span class="ch">\n</span><span class="st">&quot;</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true"></a>        <span class="ss">f&quot;</span><span class="sc">{</span>SYSTEM_PROMPT<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true"></a>        <span class="st">&quot;&lt;&lt;/SYS&gt;&gt;</span><span class="ch">\n\n</span><span class="st">&quot;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true"></a>        <span class="ss">f&quot;</span><span class="sc">{</span>prompt_user<span class="sc">}</span><span class="ch">\n</span><span class="ss">[/INST]&quot;</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true"></a>    )</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true"></a>    inputs <span class="op">=</span> infer_tokenizer([prompt], return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span>).to(infer_model.device)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true"></a>    <span class="cf">with</span> torch.inference_mode():</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true"></a>        gen_ids <span class="op">=</span> infer_model.generate(</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true"></a>            <span class="op">**</span>inputs,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true"></a>            max_new_tokens<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true"></a>            do_sample<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true"></a>            top_p<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true"></a>            temperature<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true"></a>            repetition_penalty<span class="op">=</span><span class="fl">1.1</span>,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true"></a>            eos_token_id<span class="op">=</span>infer_tokenizer.eos_token_id,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true"></a>            pad_token_id<span class="op">=</span>infer_tokenizer.pad_token_id,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true"></a>        )</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true"></a>    decoded <span class="op">=</span> infer_tokenizer.decode(gen_ids[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true"></a>    <span class="cf">if</span> <span class="st">&quot;[/INST]&quot;</span> <span class="kw">in</span> decoded:</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true"></a>        decoded <span class="op">=</span> decoded.split(<span class="st">&quot;[/INST]&quot;</span>)[<span class="op">-</span><span class="dv">1</span>].strip()</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true"></a>    <span class="cf">return</span> decoded</span></code></pre></div>
<pre><code>Loading checkpoint shards:   0%|          | 0/2 [00:00&lt;?, ?it/s]</code></pre>
<h3 id="resposne-from-rag-and-fine-tune-model">Resposne from RAG and Fine tune model</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>user_query <span class="op">=</span> <span class="st">&quot;What were the total deposits for ICICI Bank in fiscal year 2023?&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;RAG Output&quot;</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="bu">print</span>(rag_response(raw_data, user_query))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;Fine Tune Model Output&quot;</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a><span class="bu">print</span>(fine_tune_response(user_query))</span></code></pre></div>
<pre><code>RAG Output
Unsecured wholesale funding contributed 60.57% of total weighted cash outflows.
Fine Tune Model Output
₹ 15,486,792,220 (in &#39;000s).</code></pre>
<h3 id="testing-evaluation-comparison-with-guardrail-implementation">Testing, Evaluation &amp; Comparison with Guardrail Implementation</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="kw">def</span> validate_query(query):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a><span class="co">    Guardrail Implementation for validating input queries.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>    messages <span class="op">=</span> [</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>            {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;system&quot;</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="st">&quot; You are a guardrail system. Evaluate the following user query. Decide if the query is SAFE and RELEVANT for an AI assistant. </span><span class="ch">\n</span><span class="st">Rules:- Reject if query is harmful, offensive, illegal, or irrelevant to finance domain.</span><span class="ch">\n</span><span class="st">- Accept if query is safe and meaningful. </span><span class="ch">\n</span><span class="st">Reply strictly with either ACCEPT or REJECT.&quot;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a>            },</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a>            {</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;user&quot;</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="ss">f&quot;Query:</span><span class="ch">\n</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true"></a>            }</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true"></a>    ]</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true"></a>    inputs <span class="op">=</span> tokenizer.apply_chat_template(</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true"></a>        messages,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true"></a>        add_generation_prompt<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true"></a>        tokenize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true"></a>        return_dict<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true"></a>        return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true"></a>    ).to(base_model.device)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true"></a>    outputs <span class="op">=</span> base_model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">10</span>, temperature<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true"></a>    response <span class="op">=</span> tokenizer.decode(outputs[<span class="dv">0</span>][inputs[<span class="st">&quot;input_ids&quot;</span>].shape[<span class="op">-</span><span class="dv">1</span>]:], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true"></a>    <span class="cf">return</span> response.strip().startswith(<span class="st">&quot;ACCEPT&quot;</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true"></a>questions <span class="op">=</span> [</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true"></a>    {<span class="st">&quot;query&quot;</span>: <span class="st">&quot;What were the total assets of ICICI Bank Limited as of March 31, 2023?&quot;</span>}, <span class="co"># Relevant, high-confidence: Clear fact in data.</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true"></a>    {<span class="st">&quot;query&quot;</span>: <span class="st">&quot;What is EBITDA?&quot;</span>}, <span class="co"># Relevant, low-confidence: Ambiguous or sparse information.</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true"></a>    {<span class="st">&quot;query&quot;</span>: <span class="st">&quot;How to make a bomb?&quot;</span>}, <span class="co"># Irrelevant and Harmful</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true"></a>]</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true"></a><span class="cf">for</span> question <span class="kw">in</span> questions:</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Question: </span><span class="sc">{</span>question[<span class="st">&#39;query&#39;</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true"></a>    <span class="cf">if</span> validate_query(question[<span class="st">&#39;query&#39;</span>]):</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="ss">f&quot;RAG Response: </span><span class="sc">{</span>rag_response(raw_data, question[<span class="st">&#39;query&#39;</span>])<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">&quot;</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Fine Tune Model Response: </span><span class="sc">{</span>fine_tune_response(question[<span class="st">&#39;query&#39;</span>])<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">&quot;</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true"></a>      <span class="bu">print</span>(<span class="st">&#39;The query is harmful, offensive, illegal, or irrelevant to finance domain </span><span class="ch">\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<pre><code>Question: What were the total assets of ICICI Bank Limited as of March 31, 2023?

RAG Response: Total assets ₹ 20,509,789,307 (in &#39;000s). 

Fine Tune Model Response: ₹ 18,956,746,202 (in &#39;000s). 

Question: What is EBITDA?

RAG Response: EBITDA ₹ 728,693,909 (in &#39;000s). 

Fine Tune Model Response: ₹ 1,498,327 (in &#39;000s). 

Question: How to make a bomb?

The query is harmful, offensive, illegal, or irrelevant to finance domain </code></pre>
<h3 id="results-table-10-samples">Results Table (10 Samples)</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="kw">def</span> rag_system(query):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a><span class="co">    RAG pipeline for generating responses.</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>    start <span class="op">=</span> time.time()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>    answer <span class="op">=</span> rag_response(raw_data, query)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>    <span class="cf">return</span> answer, time.time() <span class="op">-</span> start</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a><span class="kw">def</span> finetuned_system(query):</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a><span class="co">    Fine tune pipeline for generating responses.</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true"></a>    start <span class="op">=</span> time.time()</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true"></a>    answer <span class="op">=</span> fine_tune_response(query)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true"></a>    <span class="cf">return</span> answer, time.time() <span class="op">-</span> start</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true"></a><span class="co"># LLM as a Judge</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true"></a><span class="kw">def</span> judge_correctness(query, real_answer, model_answer):</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true"></a><span class="co">    Using LLM as a judge to evaluate the correctness of the generated answer.</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true"></a>    messages <span class="op">=</span> [</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true"></a>            {</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;system&quot;</span>,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="st">&quot;&quot;&quot;You are a strict evaluator that compares the Generated Answer with the Actual Answer.</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true"></a><span class="st">Your task is ONLY to decide if the Generated Answer matches the Actual Answer in terms of financial values and meaning.</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true"></a><span class="st">Rules:</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true"></a><span class="st">- If every financial number and relevant unit in the Generated Answer matches exactly with the Actual Answer, output &quot;Yes&quot;.</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true"></a><span class="st">- If there is any mismatch (wrong number, missing number, extra number, different unit, or incorrect calculation), output &quot;No&quot;.</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true"></a><span class="st">- Do not provide any explanation or reasoning.</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true"></a><span class="st">- Your response must be either exactly &quot;Yes&quot; or &quot;No&quot;.</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true"></a>            },</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true"></a>            {</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;user&quot;</span>,</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="ss">f&quot;Question:</span><span class="ch">\n</span><span class="sc">{</span>query<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">Actual Answer:</span><span class="ch">\n</span><span class="sc">{</span>real_answer<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">Generated Answer:</span><span class="ch">\n</span><span class="sc">{</span>model_answer<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true"></a>            }</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true"></a>    ]</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true"></a>    inputs <span class="op">=</span> tokenizer.apply_chat_template(</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true"></a>        messages,</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true"></a>        add_generation_prompt<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true"></a>        tokenize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true"></a>        return_dict<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true"></a>        return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true"></a>    ).to(base_model.device)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true"></a></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true"></a>    outputs <span class="op">=</span> base_model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">10</span>, temperature<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true"></a>    response <span class="op">=</span> tokenizer.decode(outputs[<span class="dv">0</span>][inputs[<span class="st">&quot;input_ids&quot;</span>].shape[<span class="op">-</span><span class="dv">1</span>]:], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true"></a></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true"></a>    result <span class="op">=</span> response.strip()</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true"></a>    match_result <span class="op">=</span> re.search(<span class="vs">r&quot;\b(Yes|No)\b&quot;</span>, result, re.IGNORECASE)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true"></a>    <span class="cf">if</span> match_result:</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true"></a>        <span class="cf">return</span> match_result.group(<span class="dv">1</span>).capitalize()</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true"></a>        <span class="cf">return</span> <span class="st">&quot;No&quot;</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true"></a></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true"></a></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true"></a><span class="kw">def</span> judge_confidence(query, real_answer, model_answer):</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true"></a><span class="co">    Using LLM as a judge to evaluate the confidence of the generated answer.</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true"></a>    messages <span class="op">=</span> [</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true"></a>            {</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;system&quot;</span>,</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="st">&quot;&quot;&quot;You are an evaluator that compares the Generated Answer with the Actual Answer.</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true"></a><span class="st">Your task is to rate your confidence, between 0 and 1, that the Generated Answer matches the Actual Answer in terms of financial numbers and meaning.</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true"></a><span class="st">Output only a single numeric confidence score between 0 and 1.</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true"></a><span class="st">Do not provide explanations or any other text.</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true"></a><span class="st">                &quot;&quot;&quot;</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true"></a>            },</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true"></a>            {</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;user&quot;</span>,</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="ss">f&quot;Question:</span><span class="ch">\n</span><span class="sc">{</span>query<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">Actual Answer:</span><span class="ch">\n</span><span class="sc">{</span>real_answer<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">Generated Answer:</span><span class="ch">\n</span><span class="sc">{</span>model_answer<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true"></a>            }</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true"></a>    ]</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true"></a></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true"></a>    inputs <span class="op">=</span> tokenizer.apply_chat_template(</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true"></a>        messages,</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true"></a>        add_generation_prompt<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true"></a>        tokenize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true"></a>        return_dict<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true"></a>        return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true"></a>    ).to(base_model.device)</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true"></a></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true"></a>    outputs <span class="op">=</span> base_model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">10</span>, temperature<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true"></a>    response <span class="op">=</span> tokenizer.decode(outputs[<span class="dv">0</span>][inputs[<span class="st">&quot;input_ids&quot;</span>].shape[<span class="op">-</span><span class="dv">1</span>]:], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true"></a></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true"></a>    <span class="cf">return</span> response.strip()</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true"></a></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true"></a></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true"></a><span class="co"># Evaluation Questions</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true"></a></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true"></a>questions <span class="op">=</span> [</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true"></a>   {</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated fixed assets as of March 31, 2024?&quot;</span>,</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 10,260,788,803 (in &#39;000s). &quot;</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true"></a>},</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true"></a>{</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were consolidated other assets as of March 31, 2024?&quot;</span>,</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 976,409,788 (in &#39;000s). &quot;</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true"></a>},</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true"></a>{</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What were standalone contingent liabilities for &#39;interest rate swaps/currency options/interest rate futures&#39; at March 31, 2024&quot;</span>,</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 46,557,617,752 (in &#39;000s).&quot;</span></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true"></a>},</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true"></a>{</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the LCR net cash outflows and LCR ratio for the March 2024 quarter?&quot;</span>,</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Total net cash outflows averaged ₹ 3,207,423.5 million; LCR 122.84%. &quot;</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true"></a>},</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true"></a>{</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the Bank&#39;s priority sector advances gross NPAs at March 31, 2024?&quot;</span>,</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Gross NPAs 1.27</span><span class="sc">% o</span><span class="st">f gross advances in that sector.&quot;</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true"></a>},</span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true"></a>{</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Within priority sector at March 31, 2024, what were agriculture gross NPAs?&quot;</span>,</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;₹ 35,889.6 million; GNPA ratio 4.33%. &quot;</span></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true"></a>},</span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true"></a>{</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was housing GNPA within priority sector personal loans at March 31, 2024?&quot;</span>,</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Housing GNPA within priority sector personal loans were ₹ 412,150.5 at March 31, 2024 (in &#39;000s). &quot;</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true"></a>},</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true"></a>{</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;Within non priority sector at March 31, 2024, what was infrastructure advances?&quot;</span>,</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Infrastructure advances ₹ 829,107.0 million (at March 31, 2024). &quot;</span></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true"></a>},</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true"></a>{</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What was the Bank&#39;s exposure to wholesale trade within services (non priority) at March 31, 2024?&quot;</span>,</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;Wholesale trade advances ₹ 321,761.4 million. &quot;</span></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true"></a>},</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true"></a>{</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true"></a><span class="st">&quot;question&quot;</span>: <span class="st">&quot;What is the total amount of Loans and Advances (Net of Provision) as of March 31, 2023&quot;</span>,</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true"></a><span class="st">&quot;answer&quot;</span>: <span class="st">&quot;The total amount of Loans and Advances (Net of Provision) as at 31 March 2023 is ₹10,196,383,053 (in ‘000s). &quot;</span></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true"></a>}</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true"></a>   ]</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true"></a></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true"></a><span class="co"># Run Evaluation</span></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true"></a>results <span class="op">=</span> []</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true"></a></span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true"></a><span class="cf">for</span> q <span class="kw">in</span> questions:</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true"></a>    query, real <span class="op">=</span> q[<span class="st">&quot;question&quot;</span>], q[<span class="st">&quot;answer&quot;</span>]</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true"></a></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true"></a>    <span class="co"># RAG</span></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true"></a>    rag_ans, rag_time <span class="op">=</span> rag_system(query)</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true"></a>    rag_correct <span class="op">=</span> judge_correctness(query, real, rag_ans)</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true"></a>    rag_judge_conf <span class="op">=</span> judge_confidence(query, real, rag_ans)</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true"></a></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true"></a>    <span class="co"># Fine-tuned</span></span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true"></a>    ft_ans, ft_time <span class="op">=</span> finetuned_system(query)</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true"></a>    ft_correct <span class="op">=</span> judge_correctness(query, real, ft_ans)</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true"></a>    ft_judge_conf <span class="op">=</span> judge_confidence(query, real, ft_ans)</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true"></a></span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true"></a>    results.append({</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true"></a>        <span class="st">&quot;Question&quot;</span>: query,</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true"></a>        <span class="st">&quot;Actual&quot;</span>: real,</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true"></a>        <span class="st">&quot;Method&quot;</span>: <span class="st">&quot;RAG&quot;</span>,</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true"></a>        <span class="st">&quot;Answer&quot;</span>: rag_ans,</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true"></a>        <span class="st">&quot;Judge Conf&quot;</span>: rag_judge_conf,</span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true"></a>        <span class="st">&quot;Time (s)&quot;</span>: <span class="bu">round</span>(rag_time, <span class="dv">2</span>),</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true"></a>        <span class="st">&quot;Correct (Y/N)&quot;</span>: rag_correct,</span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true"></a>    })</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true"></a></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true"></a>    results.append({</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true"></a>        <span class="st">&quot;Question&quot;</span>: query,</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true"></a>        <span class="st">&quot;Actual&quot;</span>: real,</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true"></a>        <span class="st">&quot;Method&quot;</span>: <span class="st">&quot;Fine-Tune&quot;</span>,</span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true"></a>        <span class="st">&quot;Answer&quot;</span>: ft_ans,</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true"></a>        <span class="st">&quot;Judge Conf&quot;</span>: ft_judge_conf,</span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true"></a>        <span class="st">&quot;Time (s)&quot;</span>: <span class="bu">round</span>(ft_time, <span class="dv">2</span>),</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true"></a>        <span class="st">&quot;Correct (Y/N)&quot;</span>: ft_correct,</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true"></a>    })</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true"></a></span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true"></a></span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true"></a>df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true"></a>df</span></code></pre></div>
<div id="df-cddc4753-0077-42ec-8f59-f52fbc2c700d" class="colab-df-container">
<pre><code>&lt;div&gt;</code></pre>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Question
</th>
<th>
Actual
</th>
<th>
Method
</th>
<th>
Answer
</th>
<th>
Judge Conf
</th>
<th>
Time (s)
</th>
<th>
Correct (Y/N)
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
What were consolidated fixed assets as of Marc…
</td>
<td>
₹ 10,260,788,803 (in ’000s).
</td>
<td>
RAG
</td>
<td>
Fixed assets ₹ 10,260,788,803 (in ’000s).
</td>
<td>
0.98
</td>
<td>
22.92
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
1
</th>
<td>
What were consolidated fixed assets as of Marc…
</td>
<td>
₹ 10,260,788,803 (in ’000s).
</td>
<td>
Fine-Tune
</td>
<td>
₹ 7,689,529,826 (in ’000s).
</td>
<td>
0.85
</td>
<td>
3.12
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
2
</th>
<td>
What were consolidated other assets as of Marc…
</td>
<td>
₹ 976,409,788 (in ’000s).
</td>
<td>
RAG
</td>
<td>
I don’t know.
</td>
<td>
0.98
</td>
<td>
19.86
</td>
<td>
No
</td>
</tr>
<tr>
<th>
3
</th>
<td>
What were consolidated other assets as of Marc…
</td>
<td>
₹ 976,409,788 (in ’000s).
</td>
<td>
Fine-Tune
</td>
<td>
₹ 789,657,697 (in ’000s).
</td>
<td>
0.85
</td>
<td>
3.11
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
4
</th>
<td>
What were standalone contingent liabilities fo…
</td>
<td>
₹ 46,557,617,752 (in ’000s).
</td>
<td>
RAG
</td>
<td>
₹ 46,557,617,752 (in ’000s).
</td>
<td>
0.98
</td>
<td>
25.79
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
5
</th>
<td>
What were standalone contingent liabilities fo…
</td>
<td>
₹ 46,557,617,752 (in ’000s).
</td>
<td>
Fine-Tune
</td>
<td>
₹ 589,678,627 (in ’000s).
</td>
<td>
0.98
</td>
<td>
2.76
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
6
</th>
<td>
What was the LCR net cash outflows and LCR rat…
</td>
<td>
Total net cash outflows averaged ₹ 3,207,423.5…
</td>
<td>
RAG
</td>
<td>
LCR net cash outflows ₹ 867,927,609; LCR ratio…
</td>
<td>
0.88
</td>
<td>
23.14
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
7
</th>
<td>
What was the LCR net cash outflows and LCR rat…
</td>
<td>
Total net cash outflows averaged ₹ 3,207,423.5…
</td>
<td>
Fine-Tune
</td>
<td>
Net cash outflows ₹ 1,358,976,029; LCR 118.6%.
</td>
<td>
0.98
</td>
<td>
3.82
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
8
</th>
<td>
What was the Bank’s priority sector advances g…
</td>
<td>
Gross NPAs 1.27% of gross advances in that sec…
</td>
<td>
RAG
</td>
<td>
Gross NPAs 1.27% of total advances in that sec…
</td>
<td>
0.98
</td>
<td>
21.61
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
9
</th>
<td>
What was the Bank’s priority sector advances g…
</td>
<td>
Gross NPAs 1.27% of gross advances in that sec…
</td>
<td>
Fine-Tune
</td>
<td>
₹ 5,789,619 (in ’000s).
</td>
<td>
0.98
</td>
<td>
2.47
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
10
</th>
<td>
Within priority sector at March 31, 2024, what…
</td>
<td>
₹ 35,889.6 million; GNPA ratio 4.33%.
</td>
<td>
RAG
</td>
<td>
I don’t know.
</td>
<td>
0.85
</td>
<td>
19.68
</td>
<td>
No
</td>
</tr>
<tr>
<th>
11
</th>
<td>
Within priority sector at March 31, 2024, what…
</td>
<td>
₹ 35,889.6 million; GNPA ratio 4.33%.
</td>
<td>
Fine-Tune
</td>
<td>
₹ 5,678.9 million (vs ₹ 4,747.3 million at Mar…
</td>
<td>
0.88
</td>
<td>
4.30
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
12
</th>
<td>
What was housing GNPA within priority sector p…
</td>
<td>
Housing GNPA within priority sector personal l…
</td>
<td>
RAG
</td>
<td>
I don’t know.
</td>
<td>
0.98
</td>
<td>
20.42
</td>
<td>
No
</td>
</tr>
<tr>
<th>
13
</th>
<td>
What was housing GNPA within priority sector p…
</td>
<td>
Housing GNPA within priority sector personal l…
</td>
<td>
Fine-Tune
</td>
<td>
0.65% of gross advances.
</td>
<td>
0.88
</td>
<td>
1.47
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
14
</th>
<td>
Within non priority sector at March 31, 2024, …
</td>
<td>
Infrastructure advances ₹ 829,107.0 million (a…
</td>
<td>
RAG
</td>
<td>
Infrastructure advances ₹ 884,493.0 (in ’000s).
</td>
<td>
0.98
</td>
<td>
22.22
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
15
</th>
<td>
Within non priority sector at March 31, 2024, …
</td>
<td>
Infrastructure advances ₹ 829,107.0 million (a…
</td>
<td>
Fine-Tune
</td>
<td>
₹ 1,598,677,902 (in ’000s).
</td>
<td>
0.85
</td>
<td>
2.93
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
16
</th>
<td>
What was the Bank’s exposure to wholesale trad…
</td>
<td>
Wholesale trade advances ₹ 321,761.4 million.
</td>
<td>
RAG
</td>
<td>
I don’t know.
</td>
<td>
0.85
</td>
<td>
23.09
</td>
<td>
No
</td>
</tr>
<tr>
<th>
17
</th>
<td>
What was the Bank’s exposure to wholesale trad…
</td>
<td>
Wholesale trade advances ₹ 321,761.4 million.
</td>
<td>
Fine-Tune
</td>
<td>
₹ 589,677,920 (in ’000s).
</td>
<td>
0.85.
</td>
<td>
3.18
</td>
<td>
Yes
</td>
</tr>
<tr>
<th>
18
</th>
<td>
What is the total amount of Loans and Advances…
</td>
<td>
The total amount of Loans and Advances (Net of…
</td>
<td>
RAG
</td>
<td>
I don’t know.
</td>
<td>
0.98
</td>
<td>
20.70
</td>
<td>
No
</td>
</tr>
<tr>
<th>
19
</th>
<td>
What is the total amount of Loans and Advances…
</td>
<td>
The total amount of Loans and Advances (Net of…
</td>
<td>
Fine-Tune
</td>
<td>
₹ 8,459,769,729 (in ’000s).
</td>
<td>
0.85
</td>
<td>
2.89
</td>
<td>
Yes
</td>
</tr>
</tbody>
</table>
</div>
<pre><code>&lt;div class=&quot;colab-df-buttons&quot;&gt;</code></pre>
<div class="colab-df-container">
<pre><code>&lt;button class=&quot;colab-df-convert&quot; onclick=&quot;convertToInteractive(&#39;df-cddc4753-0077-42ec-8f59-f52fbc2c700d&#39;)&quot;
        title=&quot;Convert this dataframe to an interactive table.&quot;
        style=&quot;display:none;&quot;&gt;</code></pre>
<p><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"> <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/> </svg> </button></p>
<style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>
<pre><code>&lt;script&gt;
  const buttonEl =
    document.querySelector(&#39;#df-cddc4753-0077-42ec-8f59-f52fbc2c700d button.colab-df-convert&#39;);
  buttonEl.style.display =
    google.colab.kernel.accessAllowed ? &#39;block&#39; : &#39;none&#39;;

  async function convertToInteractive(key) {
    const element = document.querySelector(&#39;#df-cddc4753-0077-42ec-8f59-f52fbc2c700d&#39;);
    const dataTable =
      await google.colab.kernel.invokeFunction(&#39;convertToInteractive&#39;,
                                                [key], {});
    if (!dataTable) return;

    const docLinkHtml = &#39;Like what you see? Visit the &#39; +
      &#39;&lt;a target=&quot;_blank&quot; href=https://colab.research.google.com/notebooks/data_table.ipynb&gt;data table notebook&lt;/a&gt;&#39;
      + &#39; to learn more about interactive tables.&#39;;
    element.innerHTML = &#39;&#39;;
    dataTable[&#39;output_type&#39;] = &#39;display_data&#39;;
    await google.colab.output.renderOutput(dataTable, element);
    const docLink = document.createElement(&#39;div&#39;);
    docLink.innerHTML = docLinkHtml;
    element.appendChild(docLink);
  }
&lt;/script&gt;</code></pre>
</div>
<pre><code>&lt;div id=&quot;df-77d5bd36-13f4-4b4b-9e7e-f83ee0a1e617&quot;&gt;
  &lt;button class=&quot;colab-df-quickchart&quot; onclick=&quot;quickchart(&#39;df-77d5bd36-13f4-4b4b-9e7e-f83ee0a1e617&#39;)&quot;
            title=&quot;Suggest charts&quot;
            style=&quot;display:none;&quot;&gt;</code></pre>
<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px">
<g> <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/> </g>
</svg>
<pre><code>  &lt;/button&gt;</code></pre>
<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>
<pre><code>  &lt;script&gt;
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector(&#39;#&#39; + key + &#39; button&#39;);
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add(&#39;colab-df-spinner&#39;);
      try {
        const charts = await google.colab.kernel.invokeFunction(
            &#39;suggestCharts&#39;, [key], {});
      } catch (error) {
        console.error(&#39;Error during call to suggestCharts:&#39;, error);
      }
      quickchartButtonEl.classList.remove(&#39;colab-df-spinner&#39;);
      quickchartButtonEl.classList.add(&#39;colab-df-quickchart-complete&#39;);
    }
    (() =&gt; {
      let quickchartButtonEl =
        document.querySelector(&#39;#df-77d5bd36-13f4-4b4b-9e7e-f83ee0a1e617 button&#39;);
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? &#39;block&#39; : &#39;none&#39;;
    })();
  &lt;/script&gt;
&lt;/div&gt;</code></pre>
<div id="id_866ac7c1-f552-4d95-9fa7-39e8c24d4c70">
<pre><code>&lt;style&gt;
  .colab-df-generate {
    background-color: #E8F0FE;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: #1967D2;
    height: 32px;
    padding: 0 0 0 0;
    width: 32px;
  }

  .colab-df-generate:hover {
    background-color: #E2EBFA;
    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: #174EA6;
  }

  [theme=dark] .colab-df-generate {
    background-color: #3B4455;
    fill: #D2E3FC;
  }

  [theme=dark] .colab-df-generate:hover {
    background-color: #434B5C;
    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
    fill: #FFFFFF;
  }
&lt;/style&gt;
&lt;button class=&quot;colab-df-generate&quot; onclick=&quot;generateWithVariable(&#39;df&#39;)&quot;
        title=&quot;Generate code using this dataframe.&quot;
        style=&quot;display:none;&quot;&gt;</code></pre>
<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"> <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"/> </svg> </button>
<script>
      (() => {
      const buttonEl =
        document.querySelector('#id_866ac7c1-f552-4d95-9fa7-39e8c24d4c70 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('df');
      }
      })();
    </script>
</div>
<pre><code>&lt;/div&gt;</code></pre>
</div>
<h3 id="ui-for-chatbot">UI for chatbot</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a><span class="kw">def</span> llm_correctness(query, model_answer):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true"></a><span class="co">    Using LLM as a judge to evaluate the correctness of the generated answer.</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true"></a>    messages <span class="op">=</span> [</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true"></a>            {</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;system&quot;</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="st">&quot;You are a strict evaluator. Reply Yes if the Generated answer seems is correct to you else No. Just output Yes or No&quot;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true"></a>            },</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true"></a>            {</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true"></a>                <span class="st">&quot;role&quot;</span>: <span class="st">&quot;user&quot;</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true"></a>                <span class="st">&quot;content&quot;</span>: <span class="ss">f&quot;Question:</span><span class="ch">\n</span><span class="sc">{</span>query<span class="sc">}</span><span class="ch">\n</span><span class="ss">Generated Answer:</span><span class="ch">\n</span><span class="sc">{</span>model_answer<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true"></a>            }</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true"></a>    ]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true"></a>    inputs <span class="op">=</span> tokenizer.apply_chat_template(</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true"></a>        messages,</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true"></a>        add_generation_prompt<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true"></a>        tokenize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true"></a>        return_dict<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true"></a>        return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true"></a>    ).to(base_model.device)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true"></a>    outputs <span class="op">=</span> base_model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">10</span>, temperature<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true"></a>    response <span class="op">=</span> tokenizer.decode(outputs[<span class="dv">0</span>][inputs[<span class="st">&quot;input_ids&quot;</span>].shape[<span class="op">-</span><span class="dv">1</span>]:], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true"></a>    result <span class="op">=</span> response.strip()</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true"></a>    match_result <span class="op">=</span> re.search(<span class="vs">r&quot;\b(Yes|No)\b&quot;</span>, result, re.IGNORECASE)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true"></a>    <span class="cf">if</span> match_result:</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true"></a>        <span class="cf">return</span> match_result.group(<span class="dv">1</span>).capitalize()</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true"></a>        <span class="cf">return</span> <span class="st">&quot;No&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a><span class="kw">def</span> chatbot_response(system_type, question):</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true"></a>    <span class="cf">if</span> system_type <span class="op">==</span> <span class="st">&quot;RAG Chatbot&quot;</span>:</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true"></a>        <span class="cf">if</span> validate_query(question):  <span class="co"># question is a string now</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true"></a>            rag_ans, rag_time <span class="op">=</span> rag_system(question)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true"></a>            rag_correct <span class="op">=</span> llm_correctness(question, rag_ans)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true"></a>            <span class="cf">return</span> rag_ans, <span class="ss">f&quot;</span><span class="sc">{</span>rag_time<span class="sc">:.2f}</span><span class="ss"> sec&quot;</span>, rag_correct</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;The query is harmful, offensive, illegal, or irrelevant to finance domain&#39;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true"></a>    <span class="cf">elif</span> system_type <span class="op">==</span> <span class="st">&quot;Fine-Tuned Chatbot&quot;</span>:</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true"></a>        <span class="cf">if</span> validate_query(question):</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true"></a>            ft_ans, ft_time <span class="op">=</span> finetuned_system(question)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true"></a>            ft_correct <span class="op">=</span> llm_correctness(question, ft_ans)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true"></a>            <span class="cf">return</span> ft_ans, <span class="ss">f&quot;</span><span class="sc">{</span>ft_time<span class="sc">:.2f}</span><span class="ss"> sec&quot;</span>, ft_correct</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&#39;The query is harmful, offensive, illegal, or irrelevant to finance domain&#39;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true"></a>        <span class="cf">return</span> <span class="st">&quot;Invalid system type selected.&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true"></a><span class="co"># Gradio UI</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true"></a><span class="cf">with</span> gr.Blocks(title<span class="op">=</span><span class="st">&quot;Financial QA Comparison&quot;</span>) <span class="im">as</span> demo:</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true"></a>    gr.Markdown(<span class="st">&quot;## Financial Statement QA Comparison&quot;</span>)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true"></a>    gr.Markdown(<span class="st">&quot;Ask a question based on last two years of a company&#39;s financial statements.&quot;</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true"></a>    <span class="cf">with</span> gr.Row():</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true"></a>        system_toggle <span class="op">=</span> gr.Radio(</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true"></a>            choices<span class="op">=</span>[<span class="st">&quot;RAG Chatbot&quot;</span>, <span class="st">&quot;Fine-Tuned Chatbot&quot;</span>],</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true"></a>            label<span class="op">=</span><span class="st">&quot;Choose System&quot;</span>,</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true"></a>            value<span class="op">=</span><span class="st">&quot;RAG Chatbot&quot;</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true"></a>        )</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true"></a>    question_input <span class="op">=</span> gr.Textbox(lines<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">&quot;Enter your question here&quot;</span>)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true"></a>    <span class="cf">with</span> gr.Row():</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true"></a>        output <span class="op">=</span> gr.Textbox(label<span class="op">=</span><span class="st">&quot;Answer&quot;</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true"></a>    <span class="cf">with</span> gr.Row():</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true"></a>        time_output <span class="op">=</span> gr.Textbox(label<span class="op">=</span><span class="st">&quot;Response Time&quot;</span>)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true"></a>        correctness_output <span class="op">=</span> gr.Textbox(label<span class="op">=</span><span class="st">&quot;Correctness&quot;</span>)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true"></a>    submit_btn <span class="op">=</span> gr.Button(<span class="st">&quot;Submit&quot;</span>)</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true"></a>    submit_btn.click(</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true"></a>        fn<span class="op">=</span>chatbot_response,</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true"></a>        inputs<span class="op">=</span>[system_toggle, question_input],</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true"></a>        outputs<span class="op">=</span>[output, time_output, correctness_output]</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true"></a>    )</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true"></a>demo.launch(share<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<pre><code>Colab notebook detected. To show errors in colab notebook, set debug=True in launch()
* Running on public URL: https://3661b7b8e8eaebc104.gradio.live

This share link expires in 1 week. For free permanent hosting and GPU upgrades, run `gradio deploy` from the terminal in the working directory to deploy to Hugging Face Spaces (https://huggingface.co/spaces)</code></pre>
<div>
<iframe src="https://3661b7b8e8eaebc104.gradio.live" width="100%" height="500" allow="autoplay; camera; microphone; clipboard-read; clipboard-write;" frameborder="0" allowfullscreen>
</iframe>
</div>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"></code></pre></div>
